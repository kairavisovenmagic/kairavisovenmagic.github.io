<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Products | Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css?v=13"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <meta name="description" content="Freshly baked cookies & nankhatai made with 100% atta and pure butter. Order from Kairavi’s Oven Magic, Pune."/>

  <!-- helpers so MRP shows even if CSS cache lags -->
  <style>
    .hidden{display:none!important}
    .price{display:flex;align-items:baseline;gap:6px}
    .price .mrp{font-weight:600;opacity:.7;text-decoration:line-through;font-size:.95rem}
    .detail-price.price{display:flex;align-items:baseline;gap:8px;font-weight:800;color:#1b1b1b}
    #detailMrp{font-weight:600;opacity:.7;text-decoration:line-through;font-size:1rem}
  </style>
</head>
<body class="products-page">
  <!-- FREE DELIVERY BAR -->
  <div class="freebar">
    FREE delivery over ₹1599 • Pune city
    <a href="cart.html">View Cart →</a>
  </div>

  <!-- HEADER -->
  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="Kairavi's Oven Magic logo">
        <div class="brand-text">
          <strong>Kairavi’s Oven Magic</strong>
          <span class="brand-sub">Homemade Cookies & Nankhatai</span>
        </div>
      </a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html" aria-current="page">Products</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html" class="btn-pill">Cart <span class="badge" id="cartCount">0</span></a>
        <a id="loginLink" href="login.html" class="btn-outline">Login</a>
        <a id="logoutLink" href="#" style="display:none" class="btn-outline">Logout</a>
      </nav>
    </div>
  </header>

  <!-- PAGE BANNER -->
  <section class="products-hero">
    <div class="wrap products-hero-inner">
      <div>
        <h1 class="products-title">Our Cookies & Nankhatai</h1>
        <p class="products-sub">100% atta • Pure unsalted butter • No maida • No palm oil</p>
      </div>
      <div class="legend">
        <span class="legend-dot best"></span><span>Bestseller</span>
        <span class="legend-dot new"></span><span>New</span>
      </div>
    </div>
  </section>

  <!-- FILTER BAR -->
  <div class="filterbar stick">
    <div class="wrap filterbar-inner">
      <div class="filter-left">
        <label class="search-wrap">
          <i class="fa fa-magnifying-glass"></i>
          <input id="q" type="search" placeholder="Search (e.g., ragi, gulkand)…" aria-label="Search products"/>
        </label>
        <label class="select"><span class="sub">Max price</span>
          <select id="priceMax" aria-label="Maximum price">
            <option value="">No limit</option>
            <option value="200">₹200</option>
            <option value="250">₹250</option>
            <option value="300">₹300</option>
          </select>
        </label>
        <label class="check"><input type="checkbox" id="onlyBest"> <span>Bestseller only</span></label>
      </div>
      <div class="filter-right">
        <div id="resultCount" class="result-count">Showing —</div>
        <button class="btn btn-ghost" id="clearFilters" type="button"><i class="fa fa-rotate-right"></i> Clear</button>
      </div>
    </div>
  </div>

  <!-- LIST VIEW -->
  <section class="section" id="listView">
    <div class="wrap">
      <div class="grid pro-grid" id="productsGrid"></div>
    </div>
  </section>

  <!-- DETAIL VIEW -->
  <section class="section product-detail hidden" id="detailView">
    <div class="wrap detail-grid" id="detailRoot"></div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="wrap footer-grid">
      <div class="small">© 2025 Kairavi’s Oven Magic — Kairavi Food Products</div>
      <div class="small" style="text-align:right">
        Email: <a href="mailto:kairavisovenmagic@gmail.com">kairavisovenmagic@gmail.com</a>
      </div>
    </div>
  </footer>

  <!-- WhatsApp Floating -->
  <a class="whatsapp-float" href="https://wa.me/918975149980?text=Hi%2C%20I%20want%20to%20order%20cookies" target="_blank" aria-label="Chat on WhatsApp">
    <img src="images/whatsapp.png" alt="WhatsApp">
  </a>

  <!-- ====== PRODUCTS + CART + FILTERS + DETAIL ====== -->
  <script type="module">
    import { attachHeaderAuth } from "./auth.js?v=13";
    attachHeaderAuth();

    /* ---------- DATA (3 images each; packs include optional MRP) ---------- */
    const P = (o)=>({imgs:[o.img, ...(o.imgs||[])].slice(0,3).map(x=>x||o.img), ...o});
    const PRODUCTS = [
      P({slug:"gulkand", name:"Gulkand Nankhatai", brand:"Kairavi's Homemade cookies.", price:249, img:"images/gulkand-1.png",
         imgs:["images/gulkand-box.png","images/gulkand-1.png","images/gulkand-2.png"], tags:"gulkand rose", best:true,
         packs:[{label:"250 g", price:249, mrp:349},{label:"500 g", price:489, mrp:679}],
         highlights:["100% eggless","Made with real gulkand","No maida, no palm oil"],
         shipping:["Free delivery over ₹1599 in Pune","Dispatched in 24 hours"],
         ingredients:"Whole wheat flour, butter, gulkand, sugar, cardamom, baking power"}),

      P({slug:"wheat", name:"Wheat Nankhatai", brand:"Kairavi's Homemade cookies.", price:199, img:"images/wheat-1.png",
         imgs:["images/Wheat-box.png","images/Wheat-1.png","images/Wheat-2.png"], tags:"Wheat Nankhatai", best:true,
         packs:[{label:"250 g", price:199, mrp:249},{label:"500 g", price:389, mrp:499}],
         highlights:["100% eggless","Made with 100% Wheat","No maida, no palm oil"],
         shipping:["Free delivery over ₹1599 in Pune","Dispatched in 24 hours"],
         ingredients:"Whole wheat flour, butter, sugar, cardamom, baking power"}),

      P({slug:"ragi", name:"Ragi Nankhatai", brand:"Kairavi's Homemade cookies.", price:250, img:"images/ragi.jpg",
         imgs:["images/ragi-box.jpg","images/ragi-alt.jpg"], tags:"ragi finger millet",
         packs:[{label:"250 g", price:250, mrp:329},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"oats", name:"Oats Nankhatai", brand:"Kairavi's Homemade cookies.", price:250, img:"images/oats.jpg",
         imgs:["images/oats-box.jpg","images/oats-alt.jpg"], tags:"oats",
         packs:[{label:"250 g", price:250, mrp:329},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"maize", name:"Maize (Corn) Nankhatai", brand:"Kairavi's Homemade cookies.", price:250, img:"images/maize.jpg",
         imgs:["images/maize-box.jpg","images/maize-alt.jpg"], tags:"maize corn",
         packs:[{label:"250 g", price:250, mrp:329},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"jowar", name:"Jowar Nankhatai", brand:"Kairavi's Homemade cookies.", price:250, img:"images/jowar.jpg",
         imgs:["images/jowar-box.jpg","images/jowar-alt.jpg"], tags:"jowar",
         packs:[{label:"250 g", price:250, mrp:329},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"upvas", name:"Upvas Nankhatai", brand:"Kairavi's Homemade cookies.", price:250, img:"images/upvas.jpg",
         imgs:["images/upvas-box.jpg","images/upvas-alt.jpg"], tags:"upvas fasting",
         packs:[{label:"250 g", price:250, mrp:329},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"chocolate", name:"Chocolate Nankhatai", brand:"Kairavi's Homemade cookies.", price:250, img:"images/chocolate.jpg",
         imgs:["images/chocolate-box.jpg","images/chocolate-alt.jpg"], tags:"chocolate choco", best:true,
         packs:[{label:"250 g", price:250, mrp:349},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"ajwain-sticks", name:"Ajwain Sticks", brand:"Kairavi's Homemade cookies.", price:250, img:"images/ajwain-sticks.jpg",
         imgs:["images/ajwain-sticks-box.jpg","images/ajwain-sticks-alt.jpg"], tags:"ajwain sticks",
         packs:[{label:"250 g", price:250, mrp:329},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"ajwain-cookies", name:"Ajwain Cookies", brand:"Kairavi's Homemade cookies.", price:200, img:"images/ajwain-cookies.jpg",
         imgs:["images/ajwain-cookies-box.jpg","images/ajwain-cookies-alt.jpg"], tags:"ajwain cookies",
         packs:[{label:"250 g", price:200, mrp:249},{label:"500 g", price:380, mrp:440}]}),

      P({slug:"jeera", name:"Jeera Cookies", brand:"Kairavi's Homemade cookies.", price:250, img:"images/jeera.jpg",
         imgs:["images/jeera-box.jpg","images/jeera-alt.jpg"], tags:"jeera cumin",
         packs:[{label:"250 g", price:250, mrp:329},{label:"500 g", price:480, mrp:560}]}),

      P({slug:"marble", name:"Mini Marble Cookies", brand:"Kairavi's Homemade cookies.", price:200, img:"images/marble.jpg",
         imgs:["images/marble-box.jpg","images/marble-alt.jpg"], tags:"marble vanilla chocolate", new:true,
         packs:[{label:"250 g", price:200, mrp:249},{label:"500 g", price:380, mrp:440}]})
    ];

    /* ---------- CART ---------- */
    const CART_KEY = 'kom_cart';
    const getCart = () => JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    const saveCart = (c) => { localStorage.setItem(CART_KEY, JSON.stringify(c)); updateCartCount(); toast('Added to cart'); };
    function updateCartCount(){ const el=document.getElementById('cartCount'); if(!el) return; el.textContent = getCart().reduce((s,i)=>s+i.qty,0); }
    const money = (n) => new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',minimumFractionDigits:2}).format(n);
    function toast(msg){ let t=document.querySelector('.toast'); if(!t){ t=document.createElement('div'); t.className='toast'; document.body.appendChild(t); } t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

    /* ---------- GRID (card list) ---------- */
    const grid = document.getElementById('productsGrid');

    function cardHTML(p){
      const link = `products.html?product=${encodeURIComponent(p.slug)}`;
      const id = btoa(p.slug).replace(/=/g,'');
      const firstPack = (p.packs && p.packs[0]) || {price:p.price, mrp:p.mrp || p.price};
      const unit = firstPack.price;
      const unitMrp = firstPack.mrp ?? unit;

      return `
        <article class="pro-card" data-product="${p.slug}">
          <a class="thumb link-wrap" href="${link}" aria-label="${p.name}">
            ${p.best ? '<div class="ribbon">Bestseller</div>' : ''}
            ${p.new ? '<div class="ribbon new">New</div>' : ''}
            <img loading="lazy" src="${p.img}" alt="${p.name}">
          </a>

          <div class="pro-body">
            <a class="pro-title" href="${link}">${p.name}</a>
            <div class="pro-sub">${p.brand || "Kairavi's Homemade cookies."}</div>

            <div class="price-row">
              <div class="price" id="price-${id}" data-unit="${unit}" data-mrp="${unitMrp}">
                ${money(unit)} <span class="mrp" id="mrp-${id}">${money(unitMrp)}</span>
              </div>
              <div class="pro-note">All inclusive. Shipping calculated at checkout.</div>
            </div>

            <div class="pro-packs" id="packs-${id}">
              ${(p.packs||[{label:"250 g",price:p.price,mrp:unitMrp}]).map((pk,i)=>`
                <button class="pack ${i===0?'active':''}" data-price="${pk.price}" data-mrp="${pk.mrp ?? pk.price}">${pk.label}</button>
              `).join('')}
            </div>

            <div class="row-actions compact">
              <div class="qty-control soft">
                <button class="minus" data-id="${id}">−</button>
                <span class="count" id="c-${id}">1</span>
                <button class="plus" data-id="${id}">+</button>
              </div>
              <a class="btn-card" data-id="${id}" href="#">Add to cart</a>
            </div>
          </div>
        </article>
      `;
    }

    function attachHandlers(p){
      const id = btoa(p.slug).replace(/=/g,'');
      const root = grid.querySelector(`article[data-product="${CSS.escape(p.slug)}"]`);
      const priceEl = root.querySelector(`#price-${id}`);
      const mrpEl   = root.querySelector(`#mrp-${id}`);
      const packsEl = root.querySelector(`#packs-${id}`);
      const minus = root.querySelector(`.minus[data-id="${id}"]`);
      const plus  = root.querySelector(`.plus[data-id="${id}"]`);
      const add   = root.querySelector(`.btn-card[data-id="${id}"]`);
      const count = root.querySelector(`#c-${id}`);

      let unit = Number(priceEl.dataset.unit),
          unitMrp = Number(priceEl.dataset.mrp),
          qty = 1;

      const update = ()=>{
        priceEl.firstChild.nodeValue = money(unit*qty) + ' ';
        if(mrpEl) mrpEl.textContent = money(unitMrp*qty);
        count.textContent = qty;
      };

      packsEl.querySelectorAll('.pack').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          packsEl.querySelectorAll('.pack').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          unit    = Number(btn.dataset.price);
          unitMrp = Number(btn.dataset.mrp || unit);
          priceEl.dataset.unit = unit;
          priceEl.dataset.mrp  = unitMrp;
          qty = 1; update();
        });
      });

      minus.addEventListener('click', ()=>{ if(qty>1){ qty--; update(); }});
      plus .addEventListener('click', ()=>{ if(qty<10){ qty++; update(); }});
      add  .addEventListener('click', (e)=>{
        e.preventDefault();
        const activePack = packsEl.querySelector('.pack.active')?.textContent || '1 pack';
        const key = `${p.name}|${activePack}|${unit}`;
        const cart = getCart();
        const found = cart.find(i=>i.key===key);
        if(found){ found.qty += qty; } else { cart.push({ key, name:p.name, weight:activePack, price:unit, qty }); }
        saveCart(cart);
      });

      update();
    }

    function renderGrid(list=PRODUCTS){
      grid.innerHTML = list.map(cardHTML).join('');
      list.forEach(attachHandlers);
      updateCartCount();
      applyFilters();
    }

    /* ---------- FILTERS ---------- */
    const q = document.getElementById('q');
    const priceMax = document.getElementById('priceMax');
    const onlyBest = document.getElementById('onlyBest');
    const clearFilters = document.getElementById('clearFilters');
    const resultCount = document.getElementById('resultCount');

    function applyFilters(){
      const term = q.value.trim().toLowerCase();
      const max  = priceMax.value ? parseInt(priceMax.value,10) : Infinity;
      const best = onlyBest.checked;

      let visible = 0;
      grid.querySelectorAll('.pro-card').forEach(card=>{
        const p = PRODUCTS.find(x=>x.slug===card.dataset.product);
        const base = p.packs?.[0]?.price ?? p.price;
        const show = (!term || (p.name.toLowerCase().includes(term) || (p.tags||'').toLowerCase().includes(term)))
                     && base <= max
                     && (!best || p.best);
        card.style.display = show ? '' : 'none';
        if(show) visible++;
      });
      resultCount.textContent = `Showing ${visible} item${visible===1?'':'s'}`;
    }
    [q, priceMax, onlyBest].forEach(el=>el.addEventListener('input', applyFilters));
    clearFilters.addEventListener('click', ()=>{ q.value=''; priceMax.value=''; onlyBest.checked=false; applyFilters(); });

    /* ---------- DETAIL (inside) ---------- */
    const listView = document.getElementById('listView');
    const detailView = document.getElementById('detailView');
    const detailRoot = document.getElementById('detailRoot');

    function renderDetail(p){
      const firstPack = (p.packs && p.packs[0]) || {price:p.price, mrp:p.mrp||p.price};
      const minPrice = firstPack.price;
      const minMrp   = firstPack.mrp ?? minPrice;

      detailRoot.innerHTML = `
        <div class="detail-left">
          <div class="detail-hero"><img id="heroImg" src="${p.imgs[0]}" alt="${p.name}"></div>
          <div class="detail-thumbs">
            ${p.imgs.map((src,i)=>`<img class="${i===0?'active':''}" data-src="${src}" src="${src}" alt="${p.name} ${i+1}">`).join('')}
          </div>
        </div>
        <div class="detail-right">
          <a class="back-link" href="products.html">← Back to all products</a>
          <h2 class="detail-title">${p.name}</h2>

          <div class="detail-price price" id="detailPrice" data-unit="${minPrice}" data-mrp="${minMrp}">
            ${money(minPrice)} <span id="detailMrp" class="mrp">${money(minMrp)}</span>
          </div>
          <div class="detail-sub">All inclusive. Shipping calculated at checkout.</div>

          <div class="detail-packs" id="packRow">
            ${(p.packs||[{label:"250 g", price:p.price, mrp:minMrp}]).map((pk,i)=>`
              <button class="pack ${i===0?'active':''}" data-price="${pk.price}" data-mrp="${pk.mrp ?? pk.price}">
                ${pk.label}
              </button>
            `).join('')}
          </div>

          <div class="detail-qty-row">
            <div class="qty-control soft lg">
              <button class="minus" id="dq-minus">−</button>
              <span class="count" id="dq-count">1</span>
              <button class="plus" id="dq-plus">+</button>
            </div>
            <a class="btn-solid" id="dq-add" href="#">Add to cart</a>
          </div>

          <p class="detail-desc">Classic cookie freshly baked with pure butter and premium ingredients.</p>

          <details class="acc"><summary>Highlights</summary>
            <ul>${(p.highlights||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
          </details>
          <details class="acc"><summary>Shipping</summary>
            <ul>${(p.shipping||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
          </details>
          <details class="acc"><summary>Ingredients</summary><p>${p.ingredients||'—'}</p></details>
        </div>
      `;

      // thumbs
      const hero = document.getElementById('heroImg');
      document.querySelectorAll('.detail-thumbs img').forEach(img=>{
        img.addEventListener('click', ()=>{
          document.querySelectorAll('.detail-thumbs img').forEach(t=>t.classList.remove('active'));
          img.classList.add('active');
          hero.src = img.dataset.src;
        });
      });

      // price logic (sale + mrp) with packs & qty
      let unit = minPrice, unitMrp = minMrp, qty = 1;

      const priceEl = document.getElementById('detailPrice');
      const mrpEl   = document.getElementById('detailMrp');
      const packRow = document.getElementById('packRow');
      const dqMinus = document.getElementById('dq-minus');
      const dqPlus  = document.getElementById('dq-plus');
      const dqCount = document.getElementById('dq-count');
      const dqAdd   = document.getElementById('dq-add');

      const update = ()=>{
        priceEl.firstChild.nodeValue = money(unit*qty) + ' ';
        if(mrpEl) mrpEl.textContent = money(unitMrp*qty);
        dqCount.textContent = qty;
      };

      packRow.querySelectorAll('.pack').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          packRow.querySelectorAll('.pack').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          unit    = Number(btn.dataset.price);
          unitMrp = Number(btn.dataset.mrp || unit);
          priceEl.dataset.unit = unit;
          priceEl.dataset.mrp  = unitMrp;
          qty = 1; update();
        });
      });

      dqMinus.addEventListener('click', ()=>{ if(qty>1){ qty--; update(); }});
      dqPlus .addEventListener('click', ()=>{ if(qty<10){ qty++; update(); }});
      dqAdd  .addEventListener('click', (e)=>{
        e.preventDefault();
        const weight = document.querySelector('.pack.active').textContent;
        const key = `${p.name}|${weight}|${unit}`;
        const cart = getCart();
        const found = cart.find(i=>i.key===key);
        if(found){ found.qty += qty; } else { cart.push({ key, name:p.name, weight, price:unit, qty }); }
        saveCart(cart);
      });

      update();
    }

    /* ---------- Router (list ↔ detail) ---------- */
    function route(){
      const slug = new URLSearchParams(location.search).get('product');
      if(slug){
        listView.classList.add('hidden');
        detailView.classList.remove('hidden');
        const p = PRODUCTS.find(x=>x.slug===slug);
        if(p) renderDetail(p); else detailRoot.innerHTML = '<p>Product not found.</p>';
      }else{
        detailView.classList.add('hidden');
        listView.classList.remove('hidden');
        renderGrid();
      }
      updateCartCount();
    }
    window.addEventListener('popstate', route);
    route();
  </script>

  <!-- toast host -->
  <div class="toast" style="display:none"></div>
</body>
</html>
