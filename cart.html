<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cart | Kairavi‚Äôs Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css?v=13"/>

  <!-- ‚úÖ Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4W0YRB7QQ2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4W0YRB7QQ2');
  </script>

  <!-- Razorpay Checkout (required for Pay Now) -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    /* --- Cart page layout (in addition to style.css) --- */
    .cart-wrap {display:grid;grid-template-columns:2fr 1fr;gap:22px}
    .cardish{background:#fff;border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:16px}
    .cart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cart-head h2{font-size:1.3rem}

    /* table -> responsive cards on mobile */
    .cart-table{width:100%;border-collapse:collapse}
    .cart-table th,.cart-table td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .cart-table th{font-size:.9rem;color:#7a5b47;text-transform:uppercase;letter-spacing:.02em}
    .cart-item-thumb{display:flex;gap:10px;align-items:center}
    .cart-item-thumb img{width:52px;height:52px;object-fit:cover;border-radius:8px}

    .summary{position:sticky;top:84px}
    .row{display:flex;justify-content:space-between;margin:8px 0}
    .row.total{font-weight:800;font-size:1.05rem}
    .meter{background:#faf7f3;border:1px solid #e6dcd5;border-radius:10px;padding:8px 10px;margin-top:10px}
    .meter small{display:block;color:#7a5b47}
    .bar{height:7px;background:#f0e7df;border-radius:999px;overflow:hidden;margin-top:6px}
    .bar > i{display:block;height:100%;width:0;background:#25d366;border-radius:999px}

    /* mini checkout form */
    .ch-form{margin-top:14px;display:grid;gap:8px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .field input,.field textarea,.field select{
      width:100%;padding:10px;border:1px solid #e6dcd5;border-radius:10px;background:#fff;font-size:.95rem
    }
    .field textarea{min-height:80px;resize:vertical}
    .muted{color:#7a5b47;font-size:.88rem}

    .empty{ text-align:center;color:#7a5b47;padding:26px 14px;border:1px dashed #e7ddd6;border-radius:12px;background:#fffdf9 }

    @media (max-width: 980px){ .cart-wrap{grid-template-columns:1fr} .summary{position:relative;top:auto} }
    @media (max-width: 680px){
      .cart-table thead{display:none}
      .cart-table tr{display:block;border:1px solid #eee;border-radius:12px;padding:10px;margin-bottom:10px}
      .cart-table td{display:flex;justify-content:space-between;border:none;padding:6px 4px}
      .cart-table td::before{content:attr(data-label);font-weight:600;color:#7a5b47}
      .cart-item-thumb{justify-content:flex-start}
      .grid2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- FREE DELIVERY BAR -->
  <div class="freebar">
    FREE delivery over ‚Çπ999 ‚Ä¢ Pune city
    <a href="products.html">Shop more ‚Üí</a>
  </div>

  <!-- HEADER -->
  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="logo"><strong>Kairavi‚Äôs Oven Magic</strong></a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html">Cart <span class="badge" id="cartCount">0</span></a>
        <a id="loginLink" href="login.html">Login</a>
        <a id="logoutLink" href="#" style="display:none">Logout</a>
      </nav>
    </div>
  </header>

  <!-- CART -->
  <section class="section">
    <div class="wrap">
      <div class="cart-wrap">
        <!-- Left: Items -->
        <div class="cardish">
          <div class="cart-head">
            <h2>Your Cart</h2>
            <button class="btn" id="clearCart" style="background:#eee;color:#333">Clear Cart</button>
          </div>

          <table class="cart-table" id="cartTable">
            <thead>
              <tr>
                <th style="width:42%">Item</th>
                <th>Weight</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div id="emptyState" class="empty" style="display:none">
            Your cart is empty. <br/>Discover your favourites on the <a href="products.html" style="text-decoration:underline">Products</a> page.
          </div>

          <div style="margin-top:12px">
            <a class="btn btn-ghost" href="products.html">Continue Shopping</a>
          </div>
        </div>

        <!-- Right: Summary / Checkout -->
        <aside class="cardish summary">
          <h3 style="margin-bottom:8px">Order Summary</h3>
          <div class="row"><span>Items</span><span id="itemsCount">0</span></div>
          <div class="row"><span>Subtotal</span><span>‚Çπ<span id="subtotal">0</span></span></div>
          <div class="row"><span>Delivery</span><span id="deliveryText">Enter address</span></div>

          <div class="meter">
            <small id="freeNote">Add more to reach ‚Çπ999 for free delivery</small>
            <div class="bar"><i id="freeBar"></i></div>
          </div>

          <div class="row total" style="margin-top:8px"><span>Total</span><span>‚Çπ<span id="grandTotal">0</span></span></div>
          <div class="muted">Pay securely (UPI / Cards). We‚Äôll confirm your slot on WhatsApp after payment.</div>

          <!-- Checkout form -->
          <div class="ch-form" id="checkoutForm">
            <div class="field">
              <label class="muted">Email</label>
              <input id="email" type="email" placeholder="you@email.com">
            </div>

            <div class="grid2">
              <div class="field">
                <label class="muted">First name</label>
                <input id="firstName" placeholder="First name">
              </div>
              <div class="field">
                <label class="muted">Last name</label>
                <input id="lastName" placeholder="Last name">
              </div>
            </div>

            <div class="field">
              <label class="muted">Address</label>
              <input id="address1" placeholder="House / Street / Area">
            </div>

            <div class="field">
              <label class="muted">Apartment, suite (optional)</label>
              <input id="address2" placeholder="">
            </div>

            <div class="grid2">
              <div class="field">
                <label class="muted">City</label>
                <input id="city" placeholder="City">
              </div>
              <div class="field">
                <label class="muted">State</label>
                <select id="state">
                  <option value="Maharashtra" selected>Maharashtra</option>
                  <option>Gujarat</option><option>Karnataka</option><option>Goa</option>
                  <option>Madhya Pradesh</option><option>Telangana</option><option>Delhi</option>
                </select>
              </div>
            </div>

            <div class="grid2">
              <div class="field">
                <label class="muted">PIN code</label>
                <input id="pincode" inputmode="numeric" placeholder="e.g., 411014">
              </div>
              <div class="field">
                <label class="muted">Phone <span style="color:red">*</span></label>
                <input id="phone" inputmode="tel" placeholder="+91 ‚Ä¶" required>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" id="payNowBtn" type="button" style="width:100%;margin-top:6px">
            Pay now
          </button>
          <button class="btn" id="placeOrderBtn" type="button" style="width:100%;margin-top:8px;background:#eee;color:#333">
            Fill details to Place Order
          </button>
        </aside>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="wrap footer-grid">
      <div class="small">¬© 2025 Kairavi‚Äôs Oven Magic ‚Äî Kairavi Food Products</div>
      <div class="small" style="text-align:right">
        Email: <a href="mailto:kairavisovenmagic@gmail.com">kairavisovenmagic@gmail.com</a>
      </div>
    </div>
  </footer>

  <!-- WhatsApp Floating (general site help) -->
  <a class="whatsapp-float" href="https://wa.me/919766964845" target="_blank" aria-label="WhatsApp">
    <img src="images/whatsapp.png" alt="WhatsApp">
  </a>

  <!-- ============ CART + CHECKOUT LOGIC ============ -->
  <script>
    const CART_KEY='kom_cart';
    const getCart=()=>JSON.parse(localStorage.getItem(CART_KEY)||'[]');
    const setCart=c=>localStorage.setItem(CART_KEY,JSON.stringify(c));

    const tbody=document.querySelector('#cartTable tbody');
    const subtotalEl=document.getElementById('subtotal');
    const grandEl=document.getElementById('grandTotal');
    const itemsCountEl=document.getElementById('itemsCount');
    const clearBtn=document.getElementById('clearCart');
    const freeNote=document.getElementById('freeNote');
    const freeBar=document.getElementById('freeBar');
    const emptyState=document.getElementById('emptyState');
    const deliveryText=document.getElementById('deliveryText');

    const FREE_LIMIT = 999;

    // Elements for estimate + validation
    const emailEl = document.getElementById('email');
    const fEl = document.getElementById('firstName');
    const lEl = document.getElementById('lastName');
    const a1El = document.getElementById('address1');
    const a2El = document.getElementById('address2');
    const cityEl = document.getElementById('city');
    const stateEl= document.getElementById('state');
    const pinEl  = document.getElementById('pincode');
    const phoneEl= document.getElementById('phone');
    const payBtn = document.getElementById('payNowBtn');
    const placeBtn = document.getElementById('placeOrderBtn');

    function formatINR(n){ return (n||0).toLocaleString('en-IN'); }

    // Very lightweight delivery estimate (offline):
    // - Pune (411xxx): base 49 + weight tier
    // - Rest of Maharashtra: base 79 + weight
    // - India: base 129 + weight
    // Weight tiers: every 500g adds ‚Çπ20
    function estimateShipping(pincode, totalGrams, subtotal){
      if (!pincode || String(pincode).length < 6) return {amount: null, label: 'Enter address'};
      if (subtotal >= FREE_LIMIT) return {amount: 0, label: 'FREE'};
      const grams = totalGrams || 0;
      const tiers = Math.max(0, Math.ceil(grams/500)-1); // first 500g included
      let base = 129;
      if(/^411/.test(pincode)) base = 49;                     // Pune
      else if(/^4(0|1|2|3|4)/.test(pincode)) base = 79;       // Maha broad guess
      const amount = base + tiers*20;
      return {amount, label: 'Est. ‚Çπ'+formatINR(amount)};
    }

    function parseWeightToGrams(w){
      // expects like "250 g"
      const m = String(w||'').match(/([\d.]+)\s*(g|kg)/i);
      if(!m) return 0;
      const val = parseFloat(m[1]);
      const unit = m[2].toLowerCase();
      return unit==='kg' ? Math.round(val*1000) : Math.round(val);
    }

    function guessImage(name){
      const key = (name||'').toLowerCase();
      const map = {
        'gulkand':'images/gulkand.jpg',
        'wheat':'images/wheat.jpg',
        'ragi':'images/ragi.jpg',
        'oats':'images/oats.jpg',
        'maize':'images/maize.jpg',
        'jowar':'images/jowar.jpg',
        'upvas':'images/upvas.jpg',
        'chocolate':'images/chocolate.jpg',
        'ajwain sticks':'images/ajwain-sticks.jpg',
        'ajwain cookies':'images/ajwain-cookies.jpg',
        'jeera':'images/jeera.jpg',
        'marble':'images/marble.jpg'
      };
      for(const k in map){ if(key.includes(k)) return map[k]; }
      return 'images/wheat.jpg';
    }

    function buildRow(row,i,cart){
      const tr=document.createElement('tr');
      const line=row.price*row.qty;

      tr.innerHTML=`
        <td data-label="Item">
          <div class="cart-item-thumb">
            <img src="${guessImage(row.name)}" alt="${row.name}">
            <div><strong>${row.name}</strong><div class="muted">${row.weight}</div></div>
          </div>
        </td>
        <td data-label="Weight">${row.weight}</td>
        <td data-label="Qty">
          <div class="qty-control">
            <button class="minus" aria-label="Decrease">‚àí</button>
            <span class="count">${row.qty}</span>
            <button class="plus" aria-label="Increase">+</button>
          </div>
        </td>
        <td data-label="Price">‚Çπ${formatINR(row.price)}</td>
        <td data-label="Total">‚Çπ${formatINR(line)}</td>
        <td data-label="">
          <button class="remove" title="Remove" style="border:none;background:transparent;cursor:pointer">üóëÔ∏è</button>
        </td>
      `;

      tr.querySelector('.minus').onclick=()=>{if(row.qty>1){row.qty--;setCart(cart);render()}};
      tr.querySelector('.plus').onclick =()=>{if(row.qty<99){row.qty++;setCart(cart);render()}};
      tr.querySelector('.remove').onclick=()=>{cart.splice(i,1);setCart(cart);render()};
      return tr;
    }

    function render(){
      const cart=getCart();
      tbody.innerHTML='';
      let subtotal=0, items=0, grams=0;

      cart.forEach((row,i)=>{
        items += row.qty;
        subtotal += row.price*row.qty;
        grams   += parseWeightToGrams(row.weight)*row.qty;
        tbody.appendChild(buildRow(row,i,cart));
      });

      itemsCountEl.textContent = items;
      subtotalEl.textContent = formatINR(subtotal);

      // Delivery estimate
      const est = estimateShipping(pinEl.value.trim(), grams, subtotal);
      let shipping = 0;
      if(est.amount===null){ deliveryText.textContent = est.label; shipping = 0; }
      else { deliveryText.textContent = est.amount===0 ? 'FREE' : est.label; shipping = est.amount; }

      const grand = subtotal + (shipping||0);
      grandEl.textContent = formatINR(grand);

      // Free bar
      const pct = Math.min(100, Math.max(0, Math.round((subtotal/FREE_LIMIT)*100)));
      freeBar.style.width = pct + '%';
      freeNote.textContent = subtotal >= FREE_LIMIT
        ? 'üéâ You qualify for FREE delivery in Pune!'
        : `Add ‚Çπ${formatINR(FREE_LIMIT - subtotal)} more for free delivery`;

      // Empty state
      const isEmpty = cart.length === 0;
      document.getElementById('cartTable').style.display = isEmpty ? 'none' : '';
      emptyState.style.display = isEmpty ? '' : 'none';

      // Enable/disable pay button
      const mandatoryFilled =
        a1El.value.trim()!=='' && cityEl.value.trim()!=='' && pinEl.value.trim().length===6 &&
        phoneEl.value.trim().length>=10;

      const disabled = isEmpty || !mandatoryFilled;
      function setBtn(el, ok){
        el.classList.toggle('btn-ghost', !ok);
        el.classList.toggle('btn-primary', ok);
        el.style.pointerEvents = ok ? 'auto' : 'none';
        el.style.opacity = ok ? 1 : .6;
      }
      setBtn(payBtn, !disabled);
      placeBtn.textContent = disabled ? 'Fill details to Place Order' : 'Place Order (COD on request)';
    }

    // React to input for live estimates
    ['email','firstName','lastName','address1','address2','city','state','pincode','phone'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    });

    document.addEventListener('DOMContentLoaded', render);
    clearBtn.onclick=()=>{ if(confirm('Clear cart?')){ setCart([]); render(); } };
  </script>

  <!-- Header auth link switch (Login ‚Üî My Account / Admin + Logout) -->
  <script type="module">
    import { attachHeaderAuth } from './auth.js?v=13';
    attachHeaderAuth();
  </script>

  <!-- Razorpay Pay Now (phone mandatory) -->
  <script>
    const RAZORPAY_KEY = 'rzp_test_xxxxxxxxxxxxx'; // üîÅ replace with your real key

    document.getElementById('payNowBtn').addEventListener('click', ()=>{
      const cart = JSON.parse(localStorage.getItem('kom_cart')||'[]');
      if(!cart.length){ alert('Your cart is empty.'); return; }

      const phone = document.getElementById('phone').value.trim();
      if(!/^[0-9]{10}$/.test(phone)){
        alert('Please enter a valid 10-digit phone number before proceeding.');
        document.getElementById('phone').focus();
        return;
      }

      // amounts similar to render()
      const subtotal = cart.reduce((s,i)=> s + i.price*i.qty, 0);
      if(subtotal<=0){ alert('Invalid amount'); return; }

      // recompute grams + shipping estimate
      const grams = cart.reduce((g,i)=> g + (parseFloat(String(i.weight).match(/([\d.]+)/)?.[1]||0)* (String(i.weight).toLowerCase().includes('kg')?1000:1)) * i.qty, 0);
      const shipObj = (function(pin){ 
        // Local mirror of estimator
        let shipping = 0;
        if(subtotal >= 999) return {amount:0};
        if(!pin || pin.length<6) return {amount:49};
        let base = 129;
        if(/^411/.test(pin)) base=49; else if(/^4(0|1|2|3|4)/.test(pin)) base=79;
        const tiers = Math.max(0, Math.ceil(grams/500)-1);
        return {amount: base + tiers*20};
      })(document.getElementById('pincode').value.trim());

      const shipping = shipObj.amount||0;
      const total = subtotal + shipping;

      const name = (document.getElementById('firstName').value+' '+document.getElementById('lastName').value).trim() || 'Customer';
      const email= document.getElementById('email').value || 'na@example.com';
      const address = [
        document.getElementById('address1').value,
        document.getElementById('address2').value,
        document.getElementById('city').value,
        document.getElementById('state').value,
        document.getElementById('pincode').value
      ].filter(Boolean).join(', ');

      if(!RAZORPAY_KEY || RAZORPAY_KEY.includes('xxxx')){
        alert('Razorpay key is missing. Please set RAZORPAY_KEY in cart.html');
        return;
      }

      const description = cart.map(r=>`${r.name} (${r.weight}) x ${r.qty}`).join(', ');
      const options = {
        key: RAZORPAY_KEY,
        amount: Math.round(total*100),   // in paise
        currency: "INR",
        name: "Kairavi‚Äôs Oven Magic",
        description,
        prefill: { name, email, contact: phone },
        notes: { address, shipping: String(shipping), subtotal: String(subtotal) },
        theme: { color: "#ff7043" },
        handler: function (response){
          // Success ‚Äì clear cart, redirect
          localStorage.removeItem('kom_cart');
          alert('Payment successful! ID: ' + response.razorpay_payment_id);
          window.location.href = 'thankyou.html';
        }
      };
      const rzp = new Razorpay(options);
      rzp.on('payment.failed', function (res){ alert('Payment failed: ' + (res.error?.description || 'try again')); });
      rzp.open();
    });
  </script>

  <!-- tiny toast placeholder (if you style .toast in CSS) -->
  <div class="toast" style="display:block;opacity:0;pointer-events:none"></div>
</body>
</html>
