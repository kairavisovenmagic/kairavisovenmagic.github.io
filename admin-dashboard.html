<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard | Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .admin-hero{background:linear-gradient(180deg,#3b2b22,#6b4b39);color:#fff;padding:42px 0}
    .admin-hero h1{font-size:1.7rem}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .tabs .btn{padding:8px 12px}
    .board{display:grid;grid-template-columns:1fr;gap:18px}
    .panel{background:#fff;border-radius:16px;box-shadow:0 10px 20px rgba(0,0,0,.06);padding:18px;border:1px solid rgba(0,0,0,.05)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .toolbar input{border:1px solid #e6dcd5;border-radius:10px;padding:8px 10px;min-width:220px}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#faf7f3;border:1px solid #e6dcd5}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:.95rem}
    .right{margin-left:auto}
    .status{margin-top:8px;font-size:.92rem}
    .status.good{color:#2e7d32}.status.bad{color:#c62828}
  </style>
</head>
<body>

  <div class="freebar">Admin Area • <a href="index.html">Go to site →</a></div>

  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html"><img src="images/logo.png" alt=""><strong>Kairavi’s Oven Magic</strong></a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="login.html" id="loginLink">My Account</a>
        <a href="#" id="logoutBtn">Log Out</a>
      </nav>
    </div>
  </header>

  <section class="admin-hero">
    <div class="wrap">
      <h1>Admin Dashboard</h1>
      <p>View customers and orders. (Access restricted to admins)</p>
    </div>
  </section>

  <section class="section">
    <div class="wrap board">

      <!-- Users -->
      <div class="panel">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
          <h2>All Users</h2>
          <span id="usersCount" class="pill">0</span>
          <div class="right toolbar">
            <input id="userSearch" type="search" placeholder="Search email or name">
            <button class="btn btn-ghost" id="exportUsers">Export CSV</button>
          </div>
        </div>
        <div style="overflow:auto">
          <table class="table" id="usersTable">
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Updated</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="uStatus" class="status"></div>
      </div>

      <!-- Orders -->
      <div class="panel">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
          <h2>All Orders</h2>
          <span id="ordersCount" class="pill">0</span>
          <div class="right toolbar">
            <input id="orderSearch" type="search" placeholder="Search by product or email">
            <button class="btn btn-ghost" id="exportOrders">Export CSV</button>
          </div>
        </div>
        <div style="overflow:auto">
          <table class="table" id="ordersTable">
            <thead><tr><th>Date</th><th>Customer</th><th>Email</th><th>Items</th><th>Total</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="oStatus" class="status"></div>
      </div>

    </div>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCk4rYYxGWI9XBLXiIR1uaIFAnf8WHZP2w",
      authDomain: "kairavis-oven-magic.firebaseapp.com",
      projectId: "kairavis-oven-magic",
      storageBucket: "kairavis-oven-magic.firebasestorage.app",
      messagingSenderId: "270897232759",
      appId: "1:270897232759:web:36ee0edc8b222046febf72"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginLink = document.getElementById('loginLink');
    const logoutBtn = document.getElementById('logoutBtn');

    const usersTBody  = document.querySelector('#usersTable tbody');
    const ordersTBody = document.querySelector('#ordersTable tbody');
    const usersCount  = document.getElementById('usersCount');
    const ordersCount = document.getElementById('ordersCount');
    const uStatus     = document.getElementById('uStatus');
    const oStatus     = document.getElementById('oStatus');
    const userSearch  = document.getElementById('userSearch');
    const orderSearch = document.getElementById('orderSearch');
    const exportUsersBtn  = document.getElementById('exportUsers');
    const exportOrdersBtn = document.getElementById('exportOrders');

    function ensureCSV(rows){
      return rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
    }
    function downloadCSV(filename, csv){
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    onAuthStateChanged(auth, async (user)=>{
      if (!user){ window.location.href='login.html'; return; }
      if (loginLink){ loginLink.textContent='My Account'; loginLink.href='my-account.html'; loginLink.title=user.email; }
      logoutBtn.onclick = ()=>signOut(auth).then(()=>location.href='login.html');

      // Gate: only admins (users/<uid>.role === 'admin')
      const meRef = doc(db,'users',user.uid);
      const meSnap = await getDoc(meRef);
      if (!meSnap.exists() || meSnap.data().role !== 'admin'){
        alert('Admin access only'); window.location.href='index.html'; return;
      }

      // Load users
      try{
        const qs = await getDocs(collection(db,'users'));
        let rows = [];
        usersTBody.innerHTML='';
        qs.forEach(d=>{
          const u = d.data();
          rows.push([u.name||'', u.email||'', u.phone||'', u.role||'user', (u.updatedAt?.toDate?u.updatedAt.toDate():u.updatedAt)||'']);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.name||''}</td><td>${u.email||''}</td><td>${u.phone||''}</td><td>${u.role||'user'}</td><td>${u.updatedAt? new Date(u.updatedAt?.toDate?u.updatedAt.toDate():u.updatedAt).toLocaleString():''}</td>`;
          usersTBody.appendChild(tr);
        });
        usersCount.textContent = rows.length;
        // search
        userSearch.addEventListener('input', ()=>{
          const t = userSearch.value.toLowerCase();
          [...usersTBody.rows].forEach(r=>{
            r.style.display = r.innerText.toLowerCase().includes(t) ? '' : 'none';
          });
        });
        exportUsersBtn.onclick = ()=>downloadCSV('users.csv', ensureCSV([['Name','Email','Phone','Role','Updated'], ...rows]));
      }catch(e){ uStatus.textContent = e.message; uStatus.className='status bad'; }

      // Load orders
      try{
        const qs = await getDocs(query(collection(db,'orders'), orderBy('createdAt','desc')));
        let rows = [];
        ordersTBody.innerHTML='';
        qs.forEach(d=>{
          const o = d.data();
          const when = o.createdAt?.toDate ? o.createdAt.toDate() : (o.createdAt || new Date());
          const itemsTxt = (o.items||[]).map(it=>`${it.name} x${it.qty}`).join(', ');
          rows.push([new Date(when).toISOString(), o.customerName||'', o.email||'', itemsTxt, o.total||0, o.status||'Placed']);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${new Date(when).toLocaleString()}</td>
                          <td>${o.customerName||''}</td>
                          <td>${o.email||''}</td>
                          <td>${itemsTxt}</td>
                          <td>₹${o.total||0}</td>
                          <td><span class="pill">${o.status||'Placed'}</span></td>`;
          ordersTBody.appendChild(tr);
        });
        ordersCount.textContent = rows.length;
        orderSearch.addEventListener('input', ()=>{
          const t = orderSearch.value.toLowerCase();
          [...ordersTBody.rows].forEach(r=>{
            r.style.display = r.innerText.toLowerCase().includes(t) ? '' : 'none';
          });
        });
        exportOrdersBtn.onclick = ()=>downloadCSV('orders.csv', ensureCSV([['Date','Customer','Email','Items','Total','Status'], ...rows]));
      }catch(e){ oStatus.textContent = e.message; oStatus.className='status bad'; }
    });
  </script>
</body>
</html>
