<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg:#FFF7F0; --ink:#1f2328; --muted:#6b7280;
      --brand:#f15a24; --brand-900:#cc4b1e; --ring:rgba(241,90,36,.18);
      --card:#fff; --stroke:#f0e6df; --shadow:0 8px 30px rgba(0,0,0,.08);
      --radius:16px;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    body{ background:var(--bg); color:var(--ink); }

    .wrap-page{max-width:1100px;margin:24px auto 80px;padding:0 16px}

    .kpi{
      display:grid; gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      margin-bottom:14px;
    }
    .kpi .card{
      background:#fff;border:1px solid #ffe3d4;border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px 16px
    }
    .kpi .label{color:var(--muted);font-size:.9rem}
    .kpi .value{font-weight:800;font-size:1.4rem;margin-top:4px}

    .toolbar{
      display:flex;gap:10px;align-items:center;margin:12px 0 8px
    }
    .toolbar input,.toolbar select,.toolbar button{
      border:1px solid #eadace;border-radius:12px;background:#fff;
      padding:10px 12px;font:inherit
    }
    .btn{cursor:pointer}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn-ghost{background:#fff}

    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:12px;border-bottom:1px solid #f1e6df;vertical-align:top}
    th{color:#8a4b2b;text-transform:uppercase;font-size:.78rem;letter-spacing:.04em}
    tr:hover{background:#fffdf9}

    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:.78rem}
    .b-new{background:#fff7ed;border:1px solid #ffd7bf;color:#a34418}
    .b-conf{background:#ecfdf5;border:1px solid #baf2de;color:#0a7d5d}
    .b-ship{background:#eff6ff;border:1px solid #c7ddff;color:#165ebe}
    .b-close{background:#fef2f2;border:1px solid #ffc9c9;color:#a11a1a}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:9998}
    .modal{
      position:fixed;inset:40px auto auto 50%;transform:translateX(-50%);
      width:min(950px,92vw);max-height:85vh;overflow:auto;background:#fff;
      border-radius:16px;border:1px solid #ffe3d4;box-shadow:var(--shadow);display:none;z-index:9999
    }
    .modal .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px dashed #f1e6df}
    .modal .body{padding:14px 16px}
    .panel{background:#fff;border:1px solid #f1e6df;border-radius:12px;padding:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center}

    /* Invoice (print window) */
    .print-wrap{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .print-h{display:flex;gap:12px;align-items:center}
    .print-h img{width:42px;height:42px}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0}
    .tab{width:100%;border-collapse:collapse}
    .tab th,.tab td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .total-row td{font-weight:700}
    .print-footer{margin-top:10px;font-size:.9rem;color:#6b7280}
    @media print{
      body{background:#fff}
    }

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .2s;z-index:10000
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="logo"/><strong>Kairavi’s Oven Magic</strong>
      </a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a id="loginLink" href="login.html">Login</a>
        <a id="logoutLink" href="#" style="display:none">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap-page">
    <h1 style="margin:8px 0 12px;font-size:28px;font-weight:800">Admin Dashboard</h1>

    <!-- KPIs -->
    <section class="kpi">
      <div class="card">
        <div class="label">Total orders</div>
        <div class="value" id="kpiTotal">0</div>
      </div>
      <div class="card">
        <div class="label">NEW</div>
        <div class="value" id="kpiNew">0</div>
      </div>
      <div class="card">
        <div class="label">CONFIRMED</div>
        <div class="value" id="kpiConf">0</div>
      </div>
      <div class="card">
        <div class="label">Revenue (₹)</div>
        <div class="value" id="kpiRev">0</div>
      </div>
    </section>

    <!-- Toolbar -->
    <div class="toolbar">
      <input id="q" placeholder="Search name / phone / order id"/>
      <select id="statusSel">
        <option value="">All statuses</option>
        <option value="NEW">NEW</option>
        <option value="CONFIRMED">CONFIRMED</option>
        <option value="SHIPPED">SHIPPED</option>
        <option value="CLOSED">CLOSED</option>
      </select>
      <button class="btn btn-primary" id="btnRefresh"><i class="fa fa-arrows-rotate"></i> Refresh</button>
      <div class="muted" id="countNote" style="margin-left:auto"></div>
    </div>

    <!-- Table -->
    <div style="overflow:auto;border:1px solid #ffe3d4;border-radius:12px">
      <table id="tbl">
        <thead>
          <tr>
            <th style="min-width:180px">Created</th>
            <th style="min-width:220px">Order / Customer</th>
            <th>Items</th>
            <th style="min-width:80px">Total</th>
            <th style="min-width:100px">Status</th>
            <th style="min-width:200px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal -->
  <div class="overlay" id="overlay"></div>
  <div class="modal" id="modal">
    <div class="head">
      <div id="mTitle"></div>
      <div class="right">
        <button class="btn btn-ghost" id="mClose"><i class="fa fa-xmark"></i> Close</button>
      </div>
    </div>
    <div class="body" id="mBody"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { attachHeaderAuth, requireAdmin, db } from "./auth.js";
    import {
      collection, getDocs, orderBy, query, updateDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    attachHeaderAuth();
    await requireAdmin();

    // ---------- helpers ----------
    const $ = id => document.getElementById(id);
    const fmtINR = n => (n||0).toLocaleString('en-IN');
    const toast = msg => { const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1100); };
    // Pick first non-empty value from possible names
    const pick = (obj, ...names) => { for (const n of names){ const v=obj?.[n]; if(v!==undefined && v!==null && String(v).trim()!=='') return v; } return ''; };

    let ORDERS = [];

    // ---------- load orders ----------
    async function loadOrders() {
      const qRef = query(collection(db,'orders'), orderBy('createdAt','desc'));
      const snap = await getDocs(qRef);
      ORDERS = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderAll();
    }

    // ---------- render all ----------
    function renderAll(){
      applyStats();
      applyFilters();
    }

    // ---------- KPIs ----------
    function applyStats(){
      const total = ORDERS.length;
      const newC = ORDERS.filter(o => (o.status||'NEW')==='NEW').length;
      const conf  = ORDERS.filter(o => (o.status||'NEW')==='CONFIRMED').length;
      const rev   = ORDERS.reduce((s,o)=>s + (o.grandTotal||0), 0);
      $('kpiTotal').textContent = total;
      $('kpiNew').textContent = newC;
      $('kpiConf').textContent = conf;
      $('kpiRev').textContent  = fmtINR(rev);
    }

    // ---------- filter + table ----------
    function applyFilters(){
      const term = $('q').value.trim().toLowerCase();
      const st   = $('statusSel').value;

      const rows = ORDERS.filter(o=>{
        const matchStatus = !st || (o.status||'NEW')===st;
        const matchTerm = !term ||
          (pick(o,'orderId','id')||'').toLowerCase().includes(term) ||
          (pick(o,'customerName','custName','name')||'').toLowerCase().includes(term) ||
          (pick(o,'customerPhone','custPhone','phone')||'').toLowerCase().includes(term) ||
          (pick(o,'customerEmail','custEmail','email')||'').toLowerCase().includes(term);
        return matchStatus && matchTerm;
      });

      $('countNote').textContent = `${rows.length} order${rows.length===1?'':'s'}`;
      const tbody = $('tbody');
      tbody.innerHTML = rows.map(tr).join('');
      // wire actions
      rows.forEach(o=>{
        $('btnView-'+o.id)?.addEventListener('click',()=>openModal(o));
        $('btnConf-'+o.id)?.addEventListener('click',()=>setStatus(o,'CONFIRMED'));
        $('btnShip-'+o.id)?.addEventListener('click',()=>setStatus(o,'SHIPPED'));
        $('btnClose-'+o.id)?.addEventListener('click',()=>setStatus(o,'CLOSED'));
      });
    }

    function tr(o){
      const ts = o.createdAt?.seconds ? new Date(o.createdAt.seconds*1000) : (o.createdAt? new Date(o.createdAt): new Date());
      const when = ts.toLocaleString();
      const orderId = pick(o,'orderId','id');
      const name = pick(o,'customerName','custName','name');
      const ph   = pick(o,'customerPhone','custPhone','phone');

      const itemsTxt = Array.isArray(o.items)
        ? o.items.map(it => `${it.name||''}${it.weight?` (${it.weight})`:''} × ${it.qty||1}`).join(', ')
        : '';

      const badge = s=>{
        s = (s||'NEW').toUpperCase();
        const map = {NEW:'b-new',CONFIRMED:'b-conf',SHIPPED:'b-ship',CLOSED:'b-close'};
        const cls = map[s]||'b-new';
        return `<span class="badge ${cls}">${s}</span>`;
      };

      return `
        <tr>
          <td>
            <div>${when}</div>
          </td>
          <td>
            <div style="font-weight:700">${orderId}</div>
            <div class="muted">${name || '—'} • ${ph || '—'}</div>
          </td>
          <td>${itemsTxt}</td>
          <td>₹${fmtINR(o.grandTotal||0)}</td>
          <td>${badge(o.status)}</td>
          <td>
            <button class="btn btn-ghost" id="btnView-${o.id}"><i class="fa fa-eye"></i> View</button>
            <button class="btn btn-ghost" id="btnConf-${o.id}">Confirm</button>
            <button class="btn btn-ghost" id="btnShip-${o.id}">Ship</button>
            <button class="btn btn-ghost" id="btnClose-${o.id}">Close</button>
          </td>
        </tr>
      `;
    }

    // ---------- status update ----------
    async function setStatus(order, status){
      await updateDoc(doc(db,'orders',order.id), {
        status, updatedAt: serverTimestamp()
      });
      toast(`Status → ${status}`);
      await loadOrders();
    }

    // ---------- modal + invoice ----------
    function openModal(order){
      $('mTitle').innerHTML =
        `<strong>${pick(order,'orderId','id')}</strong> • ${new Date((order?.createdAt?.seconds||Date.now()/1000)*1000).toLocaleString()}`;

      $('mBody').innerHTML = modalInner(order);

      $('overlay').style.display='block';
      $('modal').style.display='block';

      $('btnPrint')?.addEventListener('click', () => printInvoice(order));
      $('mClose').onclick = closeModal;
    }
    function closeModal(){
      $('overlay').style.display='none';
      $('modal').style.display='none';
    }
    $('overlay').onclick = closeModal;

    function modalInner(order){
      const name   = pick(order,'customerName','custName','name') || '—';
      const phone  = pick(order,'customerPhone','custPhone','phone') || '—';
      const email  = pick(order,'customerEmail','custEmail','email') || '—';
      const addr   = pick(order,'address','custAddress') || '—';
      const pin    = pick(order,'pincode','custPincode') || '—';
      const pay    = pick(order,'payment','custPayment','payMode') || '—';

      const items = Array.isArray(order.items) ? order.items : [];
      const rows = items.map(it => `
        <tr>
          <td>${(it.name||'')}${it.weight?` (${it.weight})`:''}</td>
          <td>${it.qty||1}</td>
          <td>₹${fmtINR(it.price||0)}</td>
          <td>₹${fmtINR((it.price||0) * (it.qty||1))}</td>
        </tr>
      `).join('');

      const subtotal = order.subtotal ?? items.reduce((s,i)=>s+(i.price||0)*(i.qty||1),0);
      const delivery = order.delivery ?? 0;
      const total    = order.grandTotal ?? (subtotal + delivery);

      return `
        <div class="grid-2" style="margin:10px 0">
          <div class="panel">
            <div class="muted">Customer</div>
            <div><strong>${name}</strong></div>
            <div>${phone}</div>
            <div class="muted">${email}</div>
          </div>
          <div class="panel">
            <div class="muted">Delivery</div>
            <div>${addr}</div>
            <div>Pincode: ${pin}</div>
            <div>Payment: ${pay}</div>
          </div>
        </div>

        <div class="panel" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Items</div>
          <table class="tab">
            <thead>
              <tr><th>Item</th><th>Qty</th><th>Price</th><th>Line</th></tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr><td colspan="3" style="text-align:right">Subtotal</td><td>₹${fmtINR(subtotal)}</td></tr>
              <tr><td colspan="3" style="text-align:right">Delivery</td><td>₹${fmtINR(delivery)}</td></tr>
              <tr class="total-row"><td colspan="3" style="text-align:right"><strong>Total</strong></td><td><strong>₹${fmtINR(total)}</strong></td></tr>
            </tfoot>
          </table>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
          <button class="btn btn-primary" id="btnPrint"><i class="fa fa-print"></i> Print Invoice</button>
          <button class="btn btn-ghost" onclick="window.open('mailto:kairavisovenmagic@gmail.com')"><i class="fa fa-envelope"></i> Email</button>
        </div>
      `;
    }

    function buildInvoiceHTML(order){
      const logo = location.origin + (location.pathname.replace(/\/[^\/]*$/,'') || '') + '/images/logo.png';

      const orderId = pick(order,'orderId','id');
      const when = new Date((order?.createdAt?.seconds||Date.now()/1000)*1000).toLocaleString();

      const name   = pick(order,'customerName','custName','name') || '—';
      const phone  = pick(order,'customerPhone','custPhone','phone') || '—';
      const email  = pick(order,'customerEmail','custEmail','email') || '—';
      const addr   = pick(order,'address','custAddress') || '—';
      const pin    = pick(order,'pincode','custPincode') || '—';
      const pay    = pick(order,'payment','custPayment','payMode') || '—';

      const items = Array.isArray(order.items) ? order.items : [];
      const rows = items.map(it => `
        <tr>
          <td>${(it.name||'')}${it.weight?` (${it.weight})`:''}</td>
          <td>${it.qty||1}</td>
          <td>₹${fmtINR(it.price||0)}</td>
          <td>₹${fmtINR((it.price||0)*(it.qty||1))}</td>
        </tr>
      `).join('');

      const subtotal = order.subtotal ?? items.reduce((s,i)=>s+(i.price||0)*(i.qty||1),0);
      const delivery = order.delivery ?? 0;
      const total    = order.grandTotal ?? (subtotal + delivery);

      return `
        <html>
          <head>
            <meta charset="utf-8"/>
            <title>Invoice ${orderId}</title>
            <style>
              ${document.querySelector('style').innerHTML}
              body{padding:20px}
            </style>
          </head>
          <body class="print-wrap">
            <div class="print-h">
              <img src="${logo}" alt="logo"/>
              <div>
                <div style="font-weight:800;font-size:18px">Kairavi’s Oven Magic</div>
                <div class="muted">Homemade Cookies & Nankhatai</div>
              </div>
            </div>

            <div style="margin-top:10px">
              <div><strong>Invoice:</strong> ${orderId}</div>
              <div><strong>Date:</strong> ${when}</div>
            </div>

            <div class="cols">
              <div class="panel">
                <div class="muted">Billed To</div>
                <div><strong>${name}</strong></div>
                <div>${phone}</div>
                <div class="muted">${email}</div>
              </div>
              <div class="panel">
                <div class="muted">Delivery</div>
                <div>${addr}</div>
                <div>Pincode: ${pin}</div>
                <div>Payment: ${pay}</div>
              </div>
            </div>

            <table class="tab">
              <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Line</th></tr></thead>
              <tbody>${rows}</tbody>
              <tfoot>
                <tr><td colspan="3" style="text-align:right">Subtotal</td><td>₹${fmtINR(subtotal)}</td></tr>
                <tr><td colspan="3" style="text-align:right">Delivery</td><td>₹${fmtINR(delivery)}</td></tr>
                <tr class="total-row"><td colspan="3" style="text-align:right"><strong>Total</strong></td><td><strong>₹${fmtINR(total)}</strong></td></tr>
              </tfoot>
            </table>

            <div class="print-footer">Thank you for ordering with Kairavi’s Oven Magic! For support, write to kairavisovenmagic@gmail.com</div>

            <script>
              window.onload = () => {
                setTimeout(() => { window.print(); }, 150);
              };
            <\/script>
          </body>
        </html>
      `;
    }

    function printInvoice(order){
      const w = window.open('', '_blank', 'noopener,noreferrer,width=900,height=900');
      w.document.open();
      w.document.write(buildInvoiceHTML(order));
      w.document.close();
    }

    // wire UI
    $('btnRefresh').onclick = loadOrders;
    $('q').addEventListener('input', applyFilters);
    $('statusSel').addEventListener('change', applyFilters);

    // go!
    loadOrders();
  </script>
</body>
</html>
