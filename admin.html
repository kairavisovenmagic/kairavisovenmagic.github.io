<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard — Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css?v=7"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg:#FFF7F0; --ink:#1f2328; --muted:#6b7280;
      --brand:#f15a24; --brand-900:#cc4b1e; --ring:rgba(241,90,36,.18);
      --card:#fff; --stroke:#f0e6df; --shadow:0 16px 40px rgba(0,0,0,.08);
      --radius:18px;
    }
    body{ background:var(--bg); color:var(--ink); }

    .page{ max-width:1180px; margin:28px auto 60px; padding:0 16px; }
    .title{ font-size:36px; margin:0 0 4px; }
    .sub{ color:var(--muted); margin:0 0 20px; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .tool-left, .tool-right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--stroke); background:#fff; cursor:pointer; }
    .btn:hover{ background:#fafafa; }
    .btn-primary{ background:var(--brand); border-color:var(--brand); color:#fff; }
    .btn-primary:hover{ background:var(--brand-900); }

    .kpis{ display:grid; gap:16px; grid-template-columns:repeat(2,1fr); }
    @media (min-width:920px){ .kpis{ grid-template-columns:repeat(4,1fr);} }
    .kpi{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; border:1px solid #ffe3d4; }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:24px; font-weight:700; }

    .tabs{ margin-top:18px; border-bottom:1px solid #f1e6df; display:flex; gap:8px; }
    .tab{ padding:10px 14px; border-radius:10px 10px 0 0; background:#fff3ea; color:#8a4b2b; border:1px solid #ffd9c5; border-bottom:0; cursor:pointer; }
    .tab[aria-selected="true"]{ background:#fff; color:#1f2328; font-weight:700; }
    .panel{ background:#fff; border:1px solid #ffd9c5; border-top:0; border-radius:0 0 var(--radius) var(--radius); box-shadow:var(--shadow); padding:16px; }

    .table{ width:100%; border-collapse:separate; border-spacing:0; }
    .table th, .table td{ padding:10px 12px; border-bottom:1px dashed #f1e6df; text-align:left; }
    .table th{ font-size:12px; color:var(--muted); font-weight:600; }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }

    .input, select{ border:1px solid #eadace; padding:10px 12px; border-radius:12px; outline:0; background:#fff; }
    .input:focus, select:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); }
    .grid{ display:grid; gap:12px; }
    @media (min-width:720px){ .grid.two{ grid-template-columns:1fr 1fr; } .grid.three{ grid-template-columns:repeat(3,1fr);} }

    .empty{ padding:16px; border:1px dashed #f2e9e2; border-radius:12px; color:#6b7280; background:#fffdfc; }
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transition:opacity .2s; z-index:9999; }
    .toast.show{ opacity:1; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="logo"/><strong>Kairavi’s Oven Magic</strong>
      </a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="admin.html" aria-current="page">Admin</a>
        <a id="logoutLink" href="#">Logout</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <h1 class="title">Admin Dashboard</h1>
    <p class="sub">Orders, products & messages — only whitelisted admin emails can access this page.</p>

    <div class="toolbar">
      <div class="tool-left">
        <span id="today" class="btn" style="cursor:default"></span>
        <button class="btn" id="btnExport"><i class="fa fa-file-export"></i> Export Orders (CSV)</button>
      </div>
      <div class="tool-right">
        <button class="btn btn-primary" id="btnNewProduct"><i class="fa fa-plus"></i> New Product</button>
      </div>
    </div>

    <section class="kpis">
      <div class="kpi"><div class="label">Orders today</div><div class="value" id="kpiToday">0</div></div>
      <div class="kpi"><div class="label">Pending</div><div class="value" id="kpiPending">0</div></div>
      <div class="kpi"><div class="label">Shipped (30d)</div><div class="value" id="kpiShipped">0</div></div>
      <div class="kpi"><div class="label">Avg. order value</div><div class="value" id="kpiAOV">₹0</div></div>
    </section>

    <nav class="tabs" role="tablist" aria-label="Admin sections">
      <button class="tab" role="tab" aria-selected="true"  aria-controls="panelOrders"   id="tabOrders">Orders</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panelProducts" id="tabProducts">Products</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panelMessages" id="tabMessages">Messages</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panelSettings" id="tabSettings">Settings</button>
    </nav>

    <section class="panel" id="panelOrders" role="tabpanel" aria-labelledby="tabOrders">
      <div class="grid two" style="margin-bottom:10px">
        <input id="orderSearch" class="input" placeholder="Search orders…"/>
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option>pending</option><option>packed</option><option>shipped</option><option>cancelled</option>
        </select>
      </div>
      <div id="ordersWrap"></div>
    </section>

    <section class="panel" id="panelProducts" role="tabpanel" aria-labelledby="tabProducts" hidden>
      <h3 style="margin:0 0 10px">Catalog</h3>
      <div id="productsWrap"></div>
    </section>

    <section class="panel" id="panelMessages" role="tabpanel" aria-labelledby="tabMessages" hidden>
      <div id="msgsWrap" class="empty">No messages yet.</div>
    </section>

    <section class="panel" id="panelSettings" role="tabpanel" aria-labelledby="tabSettings" hidden>
      <div class="empty">Settings area (demo).</div>
    </section>
  </main>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script type="module">
    import { attachHeaderAuth, requireAdmin, toast } from "./auth.js?v=7"; // cache-busted

    attachHeaderAuth();
    await requireAdmin();

    const $ = (id)=>document.getElementById(id);
    const fmt = (d)=> new Date(d).toLocaleString();
    const showToast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); };

    $('today').textContent = new Date().toLocaleDateString();

    // Tiny demo data so the UI renders even on first load
    const ORDERS_KEY='kom_admin_orders';
    const read = (k,f)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(f));
    const write=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    if(!localStorage.getItem(ORDERS_KEY)){
      write(ORDERS_KEY,[
        {id:'KOM-1007', ts: Date.now()-2*3600e3, name:'Arpita', items:'Jeera x1, Gulkand x1', total:500, status:'pending'},
        {id:'KOM-1006', ts: Date.now()-26*3600e3, name:'Vishal', items:'Chocolate x2', total:500, status:'shipped'}
      ]);
    }

    function calcKPIs(){
      const list = read(ORDERS_KEY,[]);
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      const last30 = Date.now()-30*24*3600e3;

      const today=list.filter(o=>o.ts>=todayStart.getTime()).length;
      const pending=list.filter(o=>o.status==='pending').length;
      const shipped=list.filter(o=>o.status==='shipped'&&o.ts>=last30);
      const aov=shipped.length?Math.round(shipped.reduce((s,o)=>s+o.total,0)/shipped.length):0;

      $('kpiToday').textContent=today;
      $('kpiPending').textContent=pending;
      $('kpiShipped').textContent=shipped.length;
      $('kpiAOV').textContent='₹'+aov;
    }

    function renderOrders(){
      const q=$('orderSearch').value.trim().toLowerCase();
      const f=$('statusFilter').value;
      const list=read(ORDERS_KEY,[]).filter(o=>{
        const text=`${o.id} ${o.name} ${o.items}`.toLowerCase();
        return (!q||text.includes(q)) && (!f||o.status===f);
      }).sort((a,b)=>b.ts-a.ts);

      if(!list.length){ $('ordersWrap').innerHTML='<div class="empty">No orders found.</div>'; return; }
      $('ordersWrap').innerHTML = `
        <table class="table">
          <thead><tr><th>Order</th><th>Date</th><th>Customer</th><th>Items</th><th class="right">Total</th><th>Status</th></tr></thead>
          <tbody>
            ${list.map(o=>`
              <tr>
                <td class="nowrap"><strong>${o.id}</strong></td>
                <td>${fmt(o.ts)}</td>
                <td>${o.name}</td>
                <td>${o.items}</td>
                <td class="right">₹${o.total}</td>
                <td>${o.status}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }

    $('orderSearch').addEventListener('input', renderOrders);
    $('statusFilter').addEventListener('input', renderOrders);
    $('btnExport').onclick=()=>{
      const rows=read(ORDERS_KEY,[]);
      if(!rows.length){ showToast('No orders to export'); return; }
      const header=['id','date','customer','items','total','status'];
      const csv=[header.join(',')].concat(
        rows.map(o=>[o.id,new Date(o.ts).toISOString(),JSON.stringify(o.name),JSON.stringify(o.items),o.total,o.status].join(','))
      ).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kom-orders.csv'; a.click();
    };

    // Tabs
    function setTab(id){
      ['Orders','Products','Messages','Settings'].forEach(n=>{
        $('tab'+n).setAttribute('aria-selected', String(n===id));
        $('panel'+n).hidden = n!==id;
      });
    }
    $('tabOrders').onclick=()=>setTab('Orders');
    $('tabProducts').onclick=()=>setTab('Products');
    $('tabMessages').onclick=()=>setTab('Messages');
    $('tabSettings').onclick=()=>setTab('Settings');

    calcKPIs(); renderOrders();
  </script>
</body>
</html>
