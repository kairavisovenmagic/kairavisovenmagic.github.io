<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Account — Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css?v=16"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --bg:#FFF7F0; --ink:#1f2328; --muted:#6b7280;
      --brand:#f15a24; --brand-900:#cc4b1e; --ring:rgba(241,90,36,.18);
      --card:#fff; --stroke:#f0e6df; --shadow:0 8px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    body{ background:var(--bg); color:var(--ink); }
    .page{ max-width:1100px; margin:40px auto 60px; padding:0 20px; }
    .title{ font-size:34px; margin:0 0 6px; font-weight:700; }
    .sub{ color:var(--muted); margin:0 0 30px; }

    /* === layout === */
    .account-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap:20px;
    }

    .card{
      background:#fff;
      border:1px solid #ffe3d4;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .card h2{
      font-size:18px;
      margin:0 0 14px;
      border-bottom:1px dashed #f1e6df;
      padding-bottom:6px;
    }

    .profile-info{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }
    .profile-info img{
      width:54px; height:54px;
      border-radius:50%;
      border:1px solid #f3e0d6;
      object-fit:cover;
    }

    .muted{ color:var(--muted); }
    .stats{
      display:flex; justify-content:space-between; gap:10px;
    }
    .stat-box{
      flex:1;
      text-align:center;
      border:1px solid #ffe3d4;
      border-radius:12px;
      padding:10px 0;
    }
    .stat-value{ font-weight:700; font-size:20px; }
    .stat-label{ color:var(--muted); font-size:13px; }

    .list{ display:grid; gap:10px; }
    .list-item{
      padding:8px 0;
      border-bottom:1px dashed #f1e6df;
    }

    .btn{
      display:flex; align-items:center; gap:8px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid #eadace;
      background:#fff;
      cursor:pointer;
      justify-content:center;
      transition:.2s;
    }
    .btn:hover{ background:#fafafa; }
    .btn-primary{
      background:var(--brand); color:#fff; border-color:var(--brand);
    }
    .btn-primary:hover{ background:var(--brand-900); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#fffaf7;
      border:1px solid #ffe3d4;
      border-radius:999px;
      padding:8px 14px;
      color:#8a4b2b;
      font-size:14px;
    }

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      background:#111827; color:#fff;
      padding:10px 14px; border-radius:10px;
      opacity:0; transition:opacity .2s;
      z-index:9999;
    }
    .toast.show{ opacity:1; }

    /* Status chip for orders */
    .st{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.82rem}
    .NEW{background:#eef2ff}
    .CONFIRMED{background:#e9fce9}
    .SHIPPED{background:#eaf7ff}
    .CLOSED{background:#f4f4f5}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="logo"/><strong>Kairavi’s Oven Magic</strong>
      </a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a id="loginLink" href="login.html">Login</a>
        <a id="logoutLink" href="#" style="display:none">Logout</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <h1 class="title">My Account</h1>
    <p class="sub">Welcome to your account area. View your profile, actions, and recent activity.</p>

    <div class="account-grid">
      <!-- Profile -->
      <div class="card">
        <h2>Profile</h2>
        <div class="profile-info">
          <img id="accAvatar" src="images/logo.png" alt="Avatar">
          <div>
            <div id="accEmail" style="font-weight:700">—</div>
            <div class="muted" id="accUid" style="font-size:12px">—</div>
          </div>
        </div>
        <div class="stats">
          <div class="stat-box">
            <div class="stat-value" id="kOrders">0</div>
            <div class="stat-label">Orders</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="kPending">0</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="kSpent">₹0</div>
            <div class="stat-label">Total Spent</div>
          </div>
        </div>
      </div>

      <!-- Recent Orders (replaces static 'Recent Activity') -->
      <div class="card">
        <h2>Recent Orders</h2>
        <div id="activity" class="list">
          <div class="muted">Loading your recent orders…</div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="card">
        <h2>Quick Actions</h2>
        <div class="list">
          <a class="btn btn-primary" href="products.html"><i class="fa fa-cookie-bite"></i> Shop cookies</a>
          <a class="btn" href="cart.html"><i class="fa fa-cart-shopping"></i> View cart</a>
          <a class="btn" href="mailto:kairavisovenmagic@gmail.com"><i class="fa fa-envelope"></i> Contact support</a>
          <button class="btn" id="btnCopyId"><i class="fa fa-copy"></i> Copy User ID</button>
          <button class="btn" id="btnLogout"><i class="fa fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>

      <!-- Status -->
      <div class="card">
        <h2>Account Status</h2>
        <p><span class="pill"><i class="fa fa-shield-halved"></i> Email verified: <strong id="emailVer">—</strong></span></p>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Auth header + guard -->
  <script type="module">
    import { attachHeaderAuth, requireAuth } from "./auth.js?v=16";
    attachHeaderAuth();
    await requireAuth();
  </script>

  <!-- Profile + Recent Orders (Firestore) -->
  <script type="module">
    import { auth, db } from "./auth.js?v=16";
    import { onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const showToast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1100); };

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      // Profile header
      $('accEmail').textContent = user.email || '';
      $('accUid').textContent = user.uid || '';
      $('emailVer').textContent = user.emailVerified ? 'Yes' : 'No';
      if (user.photoURL) $('accAvatar').src = user.photoURL;

      // Offer verify email
      if(!user.emailVerified){
        const note = document.createElement('div');
        note.innerHTML = `<div class="muted" style="margin-top:10px">Your email is not verified. <button class="btn btn-primary" id="btnVerify">Verify now</button></div>`;
        document.querySelector('.account-grid').appendChild(note);
        note.querySelector('#btnVerify').onclick = async ()=>{
          await sendEmailVerification(user);
          showToast('Verification email sent');
        };
      }

      // --- Firestore: fetch ALL orders for stats, then render top 5 for recent ---
      const email = (user.email || '').toLowerCase();
      if (!email) {
        $('activity').innerHTML = `<div class="muted">No email on account.</div>`;
        return;
      }

      try {
        // Equality on customer.email + orderBy createdAt desc (may require composite index once)
        const qRef = query(
          collection(db, 'orders'),
          where('customer.email', '==', email),
          orderBy('createdAt', 'desc')
        );

        const snap = await getDocs(qRef);

        let totalOrders = 0;
        let pending = 0; // treat NEW or CONFIRMED as pending
        let spent = 0;
        const rows = [];

        snap.forEach((doc) => {
          const o = doc.data();
          totalOrders += 1;
          const st = (o.status || 'NEW').toUpperCase();
          if (st === 'NEW' || st === 'CONFIRMED') pending += 1;
          spent += (o.amounts?.total || 0);

          // Capture first 5 only for "Recent Orders"
          if (rows.length < 5) {
            const dt = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
            const when = dt.toLocaleString();
            const itemsTxt = (o.items || []).map(i => `${i.name} × ${i.qty}`).join(', ');
            const totalRs = (o.amounts?.total || 0).toLocaleString('en-IN');

            rows.push(`
              <div class="list-item">
                <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
                  <div>
                    <div><strong>${o.orderId || doc.id}</strong> • <span class="muted">${when}</span></div>
                    <div class="muted" style="margin-top:4px">${itemsTxt || '-'}</div>
                  </div>
                  <div style="text-align:right">
                    <div><strong>₹${totalRs}</strong></div>
                    <div class="st ${st}" style="margin-top:4px">${st}</div>
                  </div>
                </div>
              </div>
            `);
          }
        });

        // Update stats
        $('kOrders').textContent = totalOrders;
        $('kPending').textContent = pending;
        $('kSpent').textContent = '₹' + spent.toLocaleString('en-IN');

        // Render recent or empty state
        $('activity').innerHTML = rows.length
          ? rows.join('')
          : `<div class="muted">No orders yet. Start with our <a href="products.html" style="text-decoration:underline">bestsellers</a>!</div>`;

      } catch (e) {
        console.error('Failed to load orders:', e);
        $('activity').innerHTML = `<div class="muted">Could not load your orders right now. Please try again later.</div>`;
      }
    });

    // Actions
    $('btnLogout').onclick = async ()=>{ await signOut(auth); location.href = 'index.html'; };
    $('btnCopyId').onclick = ()=>{
      const id = $('accUid').textContent.trim();
      if(!id) return;
      navigator.clipboard.writeText(id);
      showToast('User ID copied');
    };
  </script>
</body>
</html>
