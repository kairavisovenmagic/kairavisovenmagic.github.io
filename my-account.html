<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Account — Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css?v=15"/>

  <style>
    /* Page polish (scoped) */
    .acct-wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:16px}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr; } }

    .cardx{background:#fff;border:1px solid #ffe3d4;border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.04)}
    .muted{color:#7a5b47}
    .row{display:flex;gap:10px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:1px solid #eee}

    .pill{display:inline-flex;align-items:center;gap:6px;background:#fff8f2;border:1px solid #ffe3d4;border-radius:999px;padding:6px 10px}
    .pill .dot{width:8px;height:8px;border-radius:50%}
    .dot.green{background:#22c55e}.dot.gray{background:#9ca3af}

    .table-wrap{overflow:auto;border:1px solid #ffe3d4;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    thead{background:#fff8f2}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f3e9e1;vertical-align:top}
    .status{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.82rem}
    .NEW{background:#eef2ff}
    .CONFIRMED{background:#e9fce9}
    .SHIPPED{background:#eaf7ff}
    .CLOSED{background:#f4f4f5}

    .empty{padding:18px;border:1px dashed #e7ddd6;border-radius:12px;text-align:center;background:#fffdf9}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="logo"/><strong>Kairavi’s Oven Magic</strong>
      </a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="cart.html">Cart</a>
        <a id="loginLink" href="login.html">Login</a>
        <a id="logoutLink" href="#" style="display:none">Logout</a>
      </nav>
    </div>
  </header>

  <main class="acct-wrap">
    <h1>My Account</h1>

    <div class="grid">
      <!-- Left: Profile -->
      <section class="cardx">
        <h3 style="margin-top:0">Profile</h3>
        <div class="row" id="profileRow">
          <img class="avatar" id="avatar" src="images/logo.png" alt="Avatar"/>
          <div>
            <div id="acctEmail" style="font-weight:700">loading…</div>
            <div class="muted" id="acctUid" style="font-size:.85rem"></div>
            <div class="pill" style="margin-top:8px">
              <span class="dot gray"></span><span id="acctRole">Customer</span>
            </div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #f3e9e1;margin:14px 0">

        <div>
          <h4 style="margin:0 0 8px">Default Delivery</h4>
          <div id="lastAddress" class="muted">Will auto-fill from your most recent order.</div>
        </div>

        <div style="margin-top:14px">
          <a class="btn btn-ghost" href="products.html">Shop more</a>
          <a class="btn" href="cart.html">Go to cart</a>
        </div>
      </section>

      <!-- Right: Recent Orders -->
      <section class="cardx">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Recent Orders</h3>
          <span id="orderCount" class="muted">—</span>
        </div>

        <div id="ordersEmpty" class="empty" style="display:none">
          No orders yet. Start with our <a href="products.html" style="text-decoration:underline">bestsellers</a>!
        </div>

        <div class="table-wrap" id="ordersTableWrap" style="display:none">
          <table>
            <thead>
              <tr>
                <th>Created</th>
                <th>Order</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="products.html">Continue shopping</a>
          <a class="btn btn-ghost" href="contact.html">Need help?</a>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast base -->
  <div class="toast" style="display:block;opacity:0;pointer-events:none"></div>

  <!-- Auth header & guard -->
  <script type="module">
    import { attachHeaderAuth, requireAuth, ADMIN_EMAILS } from "./auth.js?v=15";
    attachHeaderAuth();
    await requireAuth(); // redirect to login if not signed in

    // If the signed-in email is an admin, show a green dot + label
    const email = (window?.localStorage?.getItem('acctEmailCache')) || null;
    // (We’ll set acctEmailCache below after we get user)
  </script>

  <!-- Firestore: load recent orders for this user -->
  <script type="module">
    import { auth, db, ADMIN_EMAILS } from "./auth.js?v=15";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      collection, query, where, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const acctEmailEl = document.getElementById("acctEmail");
    const acctUidEl   = document.getElementById("acctUid");
    const avatarEl    = document.getElementById("avatar");
    const acctRoleEl  = document.getElementById("acctRole");

    const tableWrap   = document.getElementById("ordersTableWrap");
    const tbody       = document.getElementById("ordersBody");
    const emptyEl     = document.getElementById("ordersEmpty");
    const countEl     = document.getElementById("orderCount");
    const lastAddrEl  = document.getElementById("lastAddress");

    function fmt(n){ return (n||0).toLocaleString('en-IN'); }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      // Profile UI
      acctEmailEl.textContent = user.email || "(no email)";
      acctUidEl.textContent   = user.uid || "";
      if (user.photoURL) avatarEl.src = user.photoURL;
      const isAdmin = ADMIN_EMAILS.includes((user.email||"").toLowerCase());
      acctRoleEl.textContent = isAdmin ? "Admin" : "Customer";
      if (isAdmin) {
        const dot = document.querySelector(".pill .dot"); if (dot) dot.className = "dot green";
      }
      localStorage.setItem('acctEmailCache', user.email || '');

      // Fetch last 5 orders for this email
      const email = (user.email || "").toLowerCase();
      if (!email) {
        emptyEl.style.display = "";
        countEl.textContent = "0 orders";
        return;
      }

      // Firestore query: where customer.email == user.email, order by createdAt desc, limit 5
      // This may prompt Firestore to ask for a composite index the first time — follow the console link if shown.
      try {
        const qRef = query(
          collection(db, "orders"),
          where("customer.email", "==", email),
          orderBy("createdAt", "desc"),
          limit(5)
        );

        const snap = await getDocs(qRef);
        const rows = [];
        let latestAddress = null;

        snap.forEach(d => {
          const o = d.data();
          const created = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
          const createdTxt = created.toLocaleString();

          const itemsTxt = (o.items||[]).map(i => `${i.name} × ${i.qty}`).join(", ");
          const total = o.amounts?.total ?? 0;
          const st = (o.status || "NEW").toUpperCase();

          if (!latestAddress && o.customer?.address) latestAddress = o.customer.address;

          rows.push(`
            <tr>
              <td>${createdTxt}</td>
              <td><strong>${o.orderId || d.id}</strong></td>
              <td>${itemsTxt}</td>
              <td>₹${fmt(total)}</td>
              <td><span class="status ${st}">${st}</span></td>
            </tr>
          `);
        });

        const count = rows.length;
        countEl.textContent = `${count} order${count===1?'':'s'}`;

        if (count === 0) {
          emptyEl.style.display = "";
          tableWrap.style.display = "none";
        } else {
          tbody.innerHTML = rows.join("");
          tableWrap.style.display = "";
          emptyEl.style.display = "none";
        }

        if (latestAddress) lastAddrEl.textContent = latestAddress;

      } catch (e) {
        // If Firestore needs an index, it returns a link in the error (visible in Console).
        console.error("Orders load failed:", e);
        emptyEl.style.display = "";
        emptyEl.innerHTML = 'Could not load your orders right now. Please try again later.';
        tableWrap.style.display = "none";
        countEl.textContent = "—";
      }
    });
  </script>
</body>
</html>
