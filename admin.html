<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css?v=14"/>

  <style>
    /* Admin polish */
    .admin-wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:12px 0 18px}
    .stat{background:#fff;border:1px solid #ffe3d4;border-radius:14px;padding:14px}
    .stat .label{font-size:.8rem;color:#7a5b47}
    .stat .value{font-weight:800;font-size:1.2rem}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}
    .toolbar input,.toolbar select{
      padding:9px 10px;border:1px solid #e6dcd5;border-radius:10px;background:#fff
    }
    .table-wrap{overflow:auto;border:1px solid #ffe3d4;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    thead{background:#fff8f2}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f3e9e1;vertical-align:top}
    .status-pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem}
    .NEW{background:#eef2ff}.CONFIRMED{background:#e9fce9}.SHIPPED{background:#eaf7ff}.CLOSED{background:#f4f4f5}
    .muted{color:#7a5b47}
    .actions .btn{margin-right:6px}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="wrap nav">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="logo"/><strong>Kairavi’s Oven Magic</strong>
      </a>
      <nav class="menu">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="cart.html">Cart</a>
        <a id="loginLink" href="login.html">Login</a>
        <a id="logoutLink" href="#" style="display:none">Logout</a>
      </nav>
    </div>
  </header>

  <main class="admin-wrap">
    <h1>Admin Dashboard</h1>

    <!-- Top stats -->
    <div class="stat-grid">
      <div class="stat"><div class="label">Total orders</div><div id="stTotal" class="value">—</div></div>
      <div class="stat"><div class="label">NEW</div><div id="stNew" class="value">—</div></div>
      <div class="stat"><div class="label">CONFIRMED</div><div id="stConf" class="value">—</div></div>
      <div class="stat"><div class="label">Revenue (₹)</div><div id="stRev" class="value">—</div></div>
    </div>

    <!-- Controls -->
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search name / phone / orderId"/>
      <select id="statusFilter">
        <option value="">All statuses</option>
        <option>NEW</option>
        <option>CONFIRMED</option>
        <option>SHIPPED</option>
        <option>CLOSED</option>
      </select>
      <button id="btnReloadFs" class="btn btn-primary">Refresh</button>
      <span id="fsCount" class="muted">—</span>
    </div>

    <!-- Orders table -->
    <section class="card" id="ordersFs">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Created</th>
              <th>Order / Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="fsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Toast base -->
  <div class="toast" style="display:block;opacity:0;pointer-events:none"></div>

  <!-- Header auth controls -->
  <script type="module">
    import { attachHeaderAuth, requireAdmin } from './auth.js?v=14';
    attachHeaderAuth();
    await requireAdmin(); // redirect non-admins
  </script>

  <!-- Firestore: list + filter + update status -->
  <script type="module">
    import { auth, db } from './auth.js?v=14';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { collection, getDocs, orderBy, query, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const tbody   = document.getElementById('fsBody');
    const countEl = document.getElementById('fsCount');
    const qEl     = document.getElementById('q');
    const sfEl    = document.getElementById('statusFilter');

    const stTotal = document.getElementById('stTotal');
    const stNew   = document.getElementById('stNew');
    const stConf  = document.getElementById('stConf');
    const stRev   = document.getElementById('stRev');

    let ORDERS = []; // cache for filtering

    function fmt(n){ return (n||0).toLocaleString('en-IN'); }

    function renderRows(list){
      const rows = list.map(({id,o,createdTxt})=>{
        const itemsTxt = (o.items||[]).map(i=>`${i.name} × ${i.qty}`).join(', ');
        const total    = o.amounts?.total ?? 0;
        const st       = (o.status||'NEW').toUpperCase();

        return `
          <tr>
            <td>${createdTxt}</td>
            <td>
              <strong>${o.orderId || id}</strong><br>
              ${o.customer?.name || ''} • <span class="muted">${o.customer?.phone || ''}</span><br>
              <small class="muted">${o.customer?.email || ''}</small>
            </td>
            <td>${itemsTxt}</td>
            <td>₹${fmt(total)}</td>
            <td><span class="status-pill ${st}" data-status="${id}">${st}</span></td>
            <td class="actions">
              <button class="btn" data-action="CONFIRMED" data-id="${id}">Confirm</button>
              <button class="btn" data-action="SHIPPED"   data-id="${id}">Ship</button>
              <button class="btn" data-action="CLOSED"    data-id="${id}">Close</button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = rows.join('') || '<tr><td colspan="6" style="padding:10px">No orders.</td></tr>';

      // wire actions
      tbody.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.id, status = btn.dataset.action;
          await updateDoc(doc(db,'orders',id), { status });
          const pill = tbody.querySelector(`[data-status="${id}"]`);
          if (pill) { pill.textContent = status; pill.className = `status-pill ${status}`; }
          // refresh stats without reloading
          const idx = ORDERS.findIndex(x=>x.id===id);
          if (idx>-1) ORDERS[idx].o.status = status;
          updateStats(ORDERS);
        };
      });
    }

    function updateStats(list){
      stTotal.textContent = fmt(list.length);
      stNew.textContent   = fmt(list.filter(x=>(x.o.status||'NEW')==='NEW').length);
      stConf.textContent  = fmt(list.filter(x=>x.o.status==='CONFIRMED').length);
      const revenue       = list.reduce((s,x)=> s + (x.o.amounts?.total||0), 0);
      stRev.textContent   = fmt(revenue);
      countEl.textContent = `${list.length} order${list.length===1?'':'s'}`;
    }

    function applyFilters(){
      const term = (qEl.value||'').toLowerCase().trim();
      const st   = sfEl.value;
      const filtered = ORDERS.filter(({o,id})=>{
        const hay = [
          id, o.orderId, o.customer?.name, o.customer?.phone, o.customer?.email
        ].join(' ').toLowerCase();
        const matchTerm = !term || hay.includes(term);
        const matchSt   = !st || (o.status||'NEW')===st;
        return matchTerm && matchSt;
      });
      renderRows(filtered);
      updateStats(filtered);
    }

    async function loadOrders(){
      tbody.innerHTML = '<tr><td colspan="6" style="padding:10px">Loading…</td></tr>';
      const snap = await getDocs(query(collection(db,'orders'), orderBy('createdAt','desc')));

      ORDERS = [];
      snap.forEach(d=>{
        const o = d.data();
        const created = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
        const createdTxt = created.toLocaleString();
        ORDERS.push({ id:d.id, o, createdTxt });
      });

      renderRows(ORDERS);
      updateStats(ORDERS);
    }

    document.getElementById('btnReloadFs').onclick = loadOrders;
    qEl.addEventListener('input', applyFilters);
    sfEl.addEventListener('change', applyFilters);

    onAuthStateChanged(auth, async (u)=>{
      // requireAdmin in header already guards, but keep safe
      if (!u) return;
      await loadOrders();
    });
  </script>
</body>
</html>
