<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Kairavi’s Oven Magic</title>
  <link rel="icon" href="images/logo.png"/>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg:#FFF7F0; --ink:#1f2328; --muted:#6b7280;
      --brand:#f15a24; --brand-900:#cc4b1e; --ring:rgba(241,90,36,.18);
      --card:#fff; --stroke:#f0e6df; --shadow:0 8px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    body{ background:var(--bg); color:var(--ink); }
    .wrap{ max-width:1100px; margin:0 auto; padding:0 16px; }
    .admin-title{ font-size:32px; font-weight:800; margin:24px 0 12px; }

    .stat-grid{ display:grid; grid-template-columns: repeat(4,1fr); gap:14px; margin-bottom:14px; }
    .stat-card{ background:#fff; border:1px solid #ffe3d4; border-radius:12px; padding:14px; box-shadow:var(--shadow); }
    .stat-card .label{ color:var(--muted); font-size:13px; }
    .stat-card .value{ font-size:22px; font-weight:800; }

    .toolbar{ display:flex; gap:10px; align-items:center; margin:12px 0 8px; flex-wrap:wrap; }
    .input, .select, .btn{ height:38px; border-radius:10px; border:1px solid #eadace; background:#fff; padding:0 12px; }
    .btn{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
    .btn-primary{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn-primary:hover{ background:var(--brand-900); }
    .btn-ghost{ background:#fff; }
    .badge{ display:inline-block; border-radius:999px; padding:2px 8px; font-size:12px; }
    .badge-new{ background:#ffe9e0; color:#8a4b2b; }
    .badge-confirmed{ background:#e8f6ff; color:#0b78b8; }
    .badge-closed{ background:#e9f7ee; color:#186a3b; }

    table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid #ffe3d4; border-radius:12px; overflow:hidden; box-shadow:var(--shadow); }
    th,td{ padding:12px; border-bottom:1px solid #f4e7de; text-align:left; vertical-align:top; }
    th{ background:#fffaf7; font-weight:700; color:#8a4b2b; font-size:13px; }
    tr:last-child td{ border-bottom:none; }
    .muted{ color:var(--muted); font-size:13px; }
    .right{ text-align:right; }

    /* Modal */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:1000; }
    .modal-inner{ background:#fff; width:min(980px, 92vw); margin:40px auto; border-radius:14px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.2); }
    .modal-head{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eee; }
    .modal-body{ padding:16px; max-height:70vh; overflow:auto; }

    /* Order details panels */
    .order-modal { max-width: 980px; width: 100%; }
    .order-modal .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .order-modal .panel { border: 1px solid #eee; border-radius: 10px; padding: 12px; background:#fff; }
    .order-modal table { width:100%; border-collapse:collapse; }
    .order-modal th, .order-modal td { border-bottom:1px solid #eee; padding:10px; text-align:left; }
    .order-modal tfoot td { font-weight:700; }
    .order-modal .btn-row { display:flex; gap:10px; flex-wrap:wrap; padding-top:10px; }

    .invoice-brand { display:flex; align-items:center; gap:12px; }
    .invoice-brand img { width:36px; height:36px; border-radius:50%; }

    /* Print-only */
    @media print {
      body * { visibility: hidden; }
      #invoicePrintRoot, #invoicePrintRoot * { visibility: visible; }
      #invoicePrintRoot { position: fixed; inset: 0; background:#fff; padding:18px; }
      .no-print { display:none !important; }
      @page { margin: 16mm; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="wrap nav" style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;">
      <a class="brand" href="index.html" style="display:flex;align-items:center;gap:10px;">
        <img src="images/logo.png" alt="logo" style="width:32px;height:32px;border-radius:50%"/>
        <strong>Kairavi’s Oven Magic</strong>
      </a>
      <nav class="menu" style="display:flex;gap:14px">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a id="loginLink" href="login.html">Admin</a>
        <a id="logoutLink" href="#" style="display:none">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1 class="admin-title">Admin Dashboard</h1>

    <!-- STAT CARDS -->
    <div class="stat-grid">
      <div class="stat-card">
        <div class="label">Total orders</div>
        <div class="value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="label">NEW</div>
        <div class="value" id="statNew">0</div>
      </div>
      <div class="stat-card">
        <div class="label">CONFIRMED</div>
        <div class="value" id="statConfirmed">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Revenue (₹)</div>
        <div class="value" id="statRevenue">0</div>
      </div>
    </div>

    <!-- TOOLS -->
    <div class="toolbar">
      <input id="search" class="input" placeholder="Search name / phone / email / order id"/>
      <select id="statusFilter" class="select">
        <option value="">All statuses</option>
        <option value="NEW">NEW</option>
        <option value="CONFIRMED">CONFIRMED</option>
        <option value="SHIPPED">SHIPPED</option>
        <option value="CLOSED">CLOSED</option>
      </select>
      <button id="btnRefresh" class="btn btn-ghost"><i class="fa fa-rotate-right"></i> Refresh</button>
      <div class="muted" id="countLabel">0 orders</div>
    </div>

    <!-- ORDERS TABLE -->
    <table>
      <thead>
        <tr>
          <th style="width:160px">Created</th>
          <th>Order / Customer</th>
          <th>Items</th>
          <th class="right">Total</th>
          <th>Status</th>
          <th style="width:220px">Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTbody"></tbody>
    </table>
  </main>

  <!-- MODAL -->
  <div class="modal" id="adminModal" role="dialog" aria-modal="true">
    <div class="modal-inner">
      <div class="modal-head">
        <div id="modalTitle" style="font-weight:700">Order</div>
        <button class="btn no-print" id="modalClose"><i class="fa fa-xmark"></i> Close</button>
      </div>
      <div class="modal-body">
        <div id="modalContent">Loading…</div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .2s;z-index:9999;"></div>

  <!-- APP -->
  <script type="module">
    import { attachHeaderAuth, requireAdmin, auth } from "./auth.js?v=8";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    attachHeaderAuth();
    await requireAdmin();

    const db = getFirestore();

    // UI helpers
    const $ = (id)=>document.getElementById(id);
    const showToast = (m)=>{ const t=$('toast'); t.textContent=m; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',1100); };
    const fmtINR = (n)=> (n||0).toLocaleString('en-IN');
    const FREE_LIMIT = 999;
    const DEFAULT_DELIVERY = 49;

    const tbody = $('ordersTbody');
    const search = $('search');
    const statusFilter = $('statusFilter');
    const countLabel = $('countLabel');
    const statTotal = $('statTotal'), statNew=$('statNew'), statConfirmed=$('statConfirmed'), statRevenue=$('statRevenue');

    let ORDERS = [];

    $('btnRefresh').addEventListener('click', loadOrders);
    search.addEventListener('input', render);
    statusFilter.addEventListener('change', render);

    $('modalClose').onclick = () => $('adminModal').style.display='none';

    function tsToDateString(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts||Date.now()));
        return d.toLocaleString();
      }catch{return '';}
    }

    function itemsSummary(items=[]){
      return items.map(i=>`${i.name} (${i.weight||''}) × ${i.qty||1}`).join(', ');
    }

    function computeTotals(o){
      const items = o.items || [];
      const subtotal = o.subtotal ?? items.reduce((s,i)=>s + (i.price||0)*(i.qty||1), 0);
      const deliveryFee = o.deliveryFee ?? (subtotal >= FREE_LIMIT ? 0 : DEFAULT_DELIVERY);
      const total = o.total ?? (subtotal + deliveryFee);
      return { subtotal, deliveryFee, total };
    }

    async function loadOrders(){
      const qy = query(collection(db, 'orders'), orderBy('createdAt','desc'));
      const snap = await getDocs(qy);
      ORDERS = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      render();
      showToast('Orders refreshed');
    }

    function render(){
      const term = search.value.trim().toLowerCase();
      const st = statusFilter.value;

      let list = ORDERS.slice();

      if(term){
        list = list.filter(o=>{
          const hay = [
            o.orderId, o.id, o.customerName, o.customerPhone,
            o.customerEmail, o.email, o.address
          ].join(' ').toLowerCase();
          return hay.includes(term);
        });
      }

      if(st){
        list = list.filter(o => (o.status||'').toUpperCase() === st);
      }

      // stats
      statTotal.textContent = ORDERS.length;
      statNew.textContent = ORDERS.filter(o => (o.status||'NEW').toUpperCase()==='NEW').length;
      statConfirmed.textContent = ORDERS.filter(o => (o.status||'').toUpperCase()==='CONFIRMED').length;
      statRevenue.textContent = fmtINR(
        ORDERS.reduce((s,o)=> s + computeTotals(o).total, 0)
      );

      countLabel.textContent = `${list.length} order${list.length===1?'':'s'}`;

      // table
      tbody.innerHTML = list.map(o=>{
        const items = itemsSummary(o.items||[]);
        const { total } = computeTotals(o);
        const status = (o.status||'NEW').toUpperCase();
        const badge = status==='NEW' ? 'badge-new' : status==='CONFIRMED' ? 'badge-confirmed' : 'badge-closed';
        return `
          <tr data-id="${o.id}">
            <td class="muted">${tsToDateString(o.createdAt)}</td>
            <td>
              <div><strong>${o.orderId || o.id}</strong></div>
              <div class="muted">${o.customerName||'-'} • ${o.customerPhone||''}</div>
            </td>
            <td>${items||'-'}</td>
            <td class="right">₹${fmtINR(total)}</td>
            <td><span class="badge ${badge}">${status}</span></td>
            <td>
              <button class="btn btn-ghost js-details"><i class="fa fa-eye"></i> Details</button>
              <button class="btn js-confirm">Confirm</button>
              <button class="btn js-ship">Ship</button>
              <button class="btn js-close">Close</button>
            </td>
          </tr>
        `;
      }).join('');

      // hook actions
      tbody.querySelectorAll('.js-details').forEach(btn=>{
        btn.onclick = () => {
          const id = btn.closest('tr').dataset.id;
          const order = ORDERS.find(x=>x.id===id);
          openOrderModal(order);
        };
      });
      tbody.querySelectorAll('.js-confirm').forEach(btn=>{
        btn.onclick = () => updateStatus(btn, 'CONFIRMED');
      });
      tbody.querySelectorAll('.js-ship').forEach(btn=>{
        btn.onclick = () => updateStatus(btn, 'SHIPPED');
      });
      tbody.querySelectorAll('.js-close').forEach(btn=>{
        btn.onclick = () => updateStatus(btn, 'CLOSED');
      });
    }

    async function updateStatus(btn, newStatus){
      const id = btn.closest('tr').dataset.id;
      const ref = doc(db, 'orders', id);
      await updateDoc(ref, { status: newStatus });
      const ord = ORDERS.find(x=>x.id===id); if(ord) ord.status = newStatus;
      render();
      showToast(`Status → ${newStatus}`);
    }

    // ============== MODAL + PRINT ==============
    function dateStr(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts||Date.now()));
        return d.toLocaleString();
      }catch{return '';}
    }

    window.openOrderModal = function openOrderModal(order){
      if(!order) return;
      $('modalTitle').textContent = `${order.orderId||order.id||''}`;
      $('adminModal').style.display = 'block';

      const { subtotal, deliveryFee, total } = computeTotals(order);

      const name    = order.customerName || '—';
      const phone   = order.customerPhone || '—';
      const email   = order.customerEmail || order.email || '—';
      const address = order.address || '—';
      const pincode = order.pincode || '—';
      const payment = order.payment || '—';

      const rows = (order.items||[]).map(it=>{
        const line = (it.price||0) * (it.qty||1);
        return `<tr>
          <td>${it.name||''}<div class="muted">${it.weight||''}</div></td>
          <td class="right">${it.qty||1}</td>
          <td class="right">₹${fmtINR(it.price||0)}</td>
          <td class="right">₹${fmtINR(line)}</td>
        </tr>`;
      }).join('');

      $('modalContent').innerHTML = `
        <div class="order-modal">
          <div class="muted" style="margin-bottom:6px;">
            <strong>${order.orderId || order.id || ''}</strong> • ${dateStr(order.createdAt)}
          </div>
          <div class="cols">
            <div class="panel">
              <div class="muted" style="margin-bottom:6px;">Customer</div>
              <div><strong>${name}</strong></div>
              <div>${phone}</div>
              <div class="muted">${email}</div>
            </div>
            <div class="panel">
              <div class="muted" style="margin-bottom:6px;">Delivery</div>
              <div>${address}</div>
              <div>Pincode: ${pincode}</div>
              <div>Payment: ${payment}</div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
            <div class="muted" style="margin-bottom:8px;">Items</div>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="right">Qty</th>
                  <th class="right">Price</th>
                  <th class="right">Line</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
              <tfoot>
                <tr><td colspan="3" class="right muted">Subtotal</td><td class="right">₹${fmtINR(subtotal)}</td></tr>
                <tr><td colspan="3" class="right muted">Delivery</td><td class="right">₹${fmtINR(deliveryFee)}</td></tr>
                <tr><td colspan="3" class="right">Total</td><td class="right"><strong>₹${fmtINR(total)}</strong></td></tr>
              </tfoot>
            </table>

            <div class="btn-row no-print">
              <button class="btn btn-primary" id="btnPrintInvoice"><i class="fa fa-print"></i> Print Invoice</button>
              <button class="btn" id="btnModalConfirm">Confirm</button>
              <button class="btn" id="btnModalShip">Ship</button>
              <button class="btn" id="btnModalClose">Close</button>
            </div>
          </div>
        </div>
      `;

      $('btnModalClose')?.addEventListener('click', ()=> $('adminModal').style.display='none');
      $('btnModalConfirm')?.addEventListener('click', async ()=>{
        await updateDoc(doc(db,'orders',order.id), { status:'CONFIRMED' });
        order.status='CONFIRMED'; render(); showToast('Status → CONFIRMED');
      });
      $('btnModalShip')?.addEventListener('click', async ()=>{
        await updateDoc(doc(db,'orders',order.id), { status:'SHIPPED' });
        order.status='SHIPPED'; render(); showToast('Status → SHIPPED');
      });
      $('btnPrintInvoice')?.addEventListener('click', ()=> printInvoice(order));
    };

    function buildInvoiceHTML(order){
      const { subtotal, deliveryFee, total } = computeTotals(order);
      const name    = order.customerName || '—';
      const phone   = order.customerPhone || '—';
      const email   = order.customerEmail || order.email || '—';
      const address = order.address || '—';
      const pincode = order.pincode || '—';
      const payment = order.payment || '—';

      const rows = (order.items||[]).map(it=>{
        const line = (it.price||0) * (it.qty||1);
        return `<tr>
          <td>${it.name||''}<div class="muted">${it.weight||''}</div></td>
          <td class="right">${it.qty||1}</td>
          <td class="right">₹${fmtINR(it.price||0)}</td>
          <td class="right">₹${fmtINR(line)}</td>
        </tr>`;
      }).join('');

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Invoice — ${order.orderId || order.id || ''}</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#111; margin:24px; }
    .muted{ color:#6b7280; font-size:12px; }
    .right{ text-align:right; }
    .brand {
      display:flex; align-items:center; justify-content:space-between; gap:20px; margin-bottom:12px;
      border-bottom:1px solid #eee; padding-bottom:10px;
    }
    .brand .left { display:flex; align-items:center; gap:10px; }
    .brand img { width:42px; height:42px; border-radius:50%; }
    h1 { font-size:18px; margin:0; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin:12px 0; }
    .panel { border:1px solid #eee; border-radius:8px; padding:10px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th,td { border-bottom:1px solid #eee; padding:10px; }
    tfoot td { font-weight:700; }
    @media print { @page { margin: 16mm; } }
  </style>
</head>
<body>
  <div id="invoicePrintRoot">
    <div class="brand">
      <div class="left invoice-brand">
        <img src="images/logo.png" alt="Kairavi’s Oven Magic">
        <div>
          <h1>Kairavi’s Oven Magic</h1>
          <div class="muted">Homemade Cookies & Nankhatai • Pune</div>
        </div>
      </div>
      <div class="right">
        <div><strong>Invoice</strong></div>
        <div class="muted">${order.orderId || order.id || ''}</div>
        <div class="muted">${dateStr(order.createdAt)}</div>
      </div>
    </div>

    <div class="cols">
      <div class="panel">
        <div class="muted">Billed To</div>
        <div><strong>${name}</strong></div>
        <div>${phone}</div>
        <div class="muted">${email}</div>
      </div>
      <div class="panel">
        <div class="muted">Delivery</div>
        <div>${address}</div>
        <div>Pincode: ${pincode}</div>
        <div>Payment: ${payment}</div>
      </div>
    </div>

    <table>
      <thead>
        <tr><th>Item</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Line</th></tr>
      </thead>
      <tbody>${rows}</tbody>
      <tfoot>
        <tr><td colspan="3" class="right muted">Subtotal</td><td class="right">₹${fmtINR(subtotal)}</td></tr>
        <tr><td colspan="3" class="right muted">Delivery</td><td class="right">₹${fmtINR(deliveryFee)}</td></tr>
        <tr><td colspan="3" class="right">Total</td><td class="right"><strong>₹${fmtINR(total)}</strong></td></tr>
      </tfoot>
    </table>

    <div class="muted" style="margin-top:10px">
      Thank you for supporting homemade goodness! • Support: kairavisovenmagic@gmail.com
    </div>
  </div>
</body>
</html>`;
    }

    window.printInvoice = function printInvoice(order){
      const win = window.open('', '_blank', 'noopener,noreferrer');
      if(!win){ alert('Please allow pop-ups to print the invoice.'); return; }
      win.document.open();
      win.document.write(buildInvoiceHTML(order));
      win.document.close();
      win.onload = () => { win.focus(); win.print(); setTimeout(()=>win.close(), 200); };
    };

    // Start
    loadOrders();
  </script>
</body>
</html>
